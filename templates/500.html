{% extends 'layout.html' %}
{% block title %}Serveriviga – Billipocket{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
.error-page {
  min-height: 60vh;
  display: flex;
  align-items: center;
  justify-content: center;
}
.error-illustration {
  max-width: 300px;
  opacity: 0.8;
}
</style>
{% endblock %}

{% block content %}
<div class="error-page">
  <div class="container">
    <div class="row justify-content-center text-center">
      <div class="col-lg-6">
        <div class="error-illustration mb-4">
          <i class="bi bi-exclamation-triangle display-1 text-danger mb-3"></i>
          <div class="display-1 fw-bold text-danger mb-2">500</div>
        </div>
        
        <h1 class="h2 mb-3">Serveriviga</h1>
        <p class="text-muted mb-4 fs-5">
          Kahjuks tekkis süsteemis viga. Meie arendusmeeskond on sellest teavitatud 
          ja töötab probleemi lahendamise kallal.
        </p>
        
        <div class="alert alert-warning mb-4">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Mis teha?</strong>
          Palun proovige mõne minuti pärast uuesti. Kui probleem püsib, võtke meiega ühendust.
        </div>
        
        <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center mb-5">
          <button onclick="location.reload()" class="btn btn-primary">
            <i class="bi bi-arrow-clockwise me-2"></i>Proovi uuesti
          </button>
          <a href="{{ url_for('dashboard.overview') }}" class="btn btn-outline-secondary">
            <i class="bi bi-house me-2"></i>Tagasi avalehele
          </a>
        </div>

        <!-- Error Details (for development) -->
        {% if config.DEBUG %}
        <div class="bp-card mt-4">
          <div class="bp-card-header bg-danger text-white">
            <h3 class="h6 m-0">
              <i class="bi bi-bug me-2"></i>Arenduse info (ainult arendusrežiimis)
            </h3>
          </div>
          <div class="bp-card-body">
            <div class="text-start">
              <p><strong>Veateade:</strong> {{ error_message if error_message else 'Sisemise serveri viga' }}</p>
              <p><strong>Aeg:</strong> <span id="error-time"></span></p>
              <p><strong>URL:</strong> <code>{{ request.url if request else 'N/A' }}</code></p>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Support Info -->
        <div class="bp-card mt-4">
          <div class="bp-card-header">
            <h3 class="h6 m-0">
              <i class="bi bi-headset me-2"></i>Vajate abi?
            </h3>
          </div>
          <div class="bp-card-body">
            <div class="row g-3 text-start">
              <div class="col-md-6">
                <h6 class="fw-medium">
                  <i class="bi bi-envelope me-2 text-primary"></i>E-post
                </h6>
                <p class="small mb-0">
                  <a href="mailto:support@billipocket.ee" class="text-decoration-none">
                    support@billipocket.ee
                  </a>
                </p>
              </div>
              <div class="col-md-6">
                <h6 class="fw-medium">
                  <i class="bi bi-telephone me-2 text-success"></i>Telefon
                </h6>
                <p class="small mb-0">
                  <a href="tel:+37256123456" class="text-decoration-none">
                    +372 561 23456
                  </a>
                </p>
              </div>
            </div>
            <hr>
            <p class="small text-muted mb-0">
              <i class="bi bi-clock me-2"></i>
              Töötame iga päev 9:00 - 18:00
            </p>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="bp-card mt-4">
          <div class="bp-card-header">
            <h3 class="h6 m-0">
              <i class="bi bi-lightning me-2"></i>Kiired toimingud
            </h3>
          </div>
          <div class="bp-card-body">
            <div class="row g-2">
              <div class="col-6">
                <a href="{{ url_for('invoices.invoices') }}" class="btn btn-outline-primary btn-sm w-100">
                  <i class="bi bi-file-earmark-text me-1"></i>Arved
                </a>
              </div>
              <div class="col-6">
                <a href="{{ url_for('clients.clients') }}" class="btn btn-outline-success btn-sm w-100">
                  <i class="bi bi-people me-1"></i>Kliendid
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Display current time for error tracking
document.addEventListener('DOMContentLoaded', function() {
  const errorTimeElement = document.getElementById('error-time');
  if (errorTimeElement) {
    errorTimeElement.textContent = new Date().toLocaleString('et-EE');
  }
});

// Track 500 errors for analytics (if needed)
console.error('500 Error occurred at:', window.location.href);

// Auto-retry mechanism
let retryCount = 0;
const maxRetries = 3;
const retryDelay = 10000; // 10 seconds

function autoRetry() {
  if (retryCount < maxRetries) {
    retryCount++;
    console.log(`Auto-retry attempt ${retryCount}/${maxRetries}`);
    
    setTimeout(function() {
      // Try to reload the original page that caused the error
      if (document.referrer) {
        window.location.href = document.referrer;
      } else {
        location.reload();
      }
    }, retryDelay);
  }
}

// Show retry countdown
function showRetryCountdown() {
  const retryButton = document.querySelector('button[onclick="location.reload()"]');
  if (retryButton && retryCount > 0) {
    let countdown = retryDelay / 1000;
    const originalText = retryButton.innerHTML;
    
    const countdownInterval = setInterval(function() {
      retryButton.innerHTML = `<i class="bi bi-arrow-clockwise me-2"></i>Automaatne uuestiproovimine ${countdown}s`;
      countdown--;
      
      if (countdown < 0) {
        clearInterval(countdownInterval);
        retryButton.innerHTML = originalText;
      }
    }, 1000);
  }
}

// Initialize auto-retry if this is not the first attempt
const urlParams = new URLSearchParams(window.location.search);
const retry = urlParams.get('retry');

if (!retry) {
  // First time seeing this error, wait 30 seconds then try auto-retry
  setTimeout(function() {
    showRetryCountdown();
    autoRetry();
  }, 30000);
}

// Report error to analytics/monitoring service (if available)
if (window.gtag) {
  gtag('event', 'exception', {
    'description': '500 Internal Server Error',
    'fatal': false
  });
}
</script>
{% endblock %}