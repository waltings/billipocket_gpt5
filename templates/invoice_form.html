{% extends 'layout.html' %}
{% block title %}{{ title }} – Billipocket{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
.invoice-lines {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  background: #f8f9fa;
}
.invoice-line {
  background: white;
  border-bottom: 1px solid #dee2e6;
  padding: 0.5rem;
}
.invoice-line:first-child {
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
}
.invoice-line:last-child {
  border-bottom: none;
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}
.invoice-totals {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
}
.invoice-totals .table {
  background: transparent;
  margin-bottom: 0;
}
.invoice-totals .table td {
  background: transparent;
  border-color: rgba(0,0,0,0.1);
}
.remove-line-btn {
  width: 24px;
  height: 24px;
  position: relative;
  color: #dc3545 !important;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.remove-line-btn::before,
.remove-line-btn::after {
  content: '';
  position: absolute;
  width: 12px;
  height: 2px;
  background-color: #dc3545;
  border-radius: 1px;
}
.remove-line-btn::before {
  transform: rotate(45deg);
}
.remove-line-btn::after {
  transform: rotate(-45deg);
}
.remove-line-btn:hover::before,
.remove-line-btn:hover::after {
  background-color: #b02a37;
}
.invoice-line .form-control {
  border: none;
  background: transparent;
  padding: 4px 4px;
  font-size: 14px;
  border-radius: 0;
  box-shadow: none;
}
.invoice-line .form-control:focus {
  border: none;
  background: #f8f9fa;
  box-shadow: none;
  outline: none;
}
.invoice-line .input-group-text {
  border: none;
  background: transparent;
  padding: 4px 2px 4px 0;
  margin-left: -1px;
}
.invoice-line .input-group .form-control {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.invoice-line .line-price {
  text-align: right;
}
.invoice-line .line-qty {
  text-align: right;
}
.invoice-line .line-total {
  text-align: right;
}
.invoice-line input[type="number"]::-webkit-outer-spin-button,
.invoice-line input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.invoice-line input[type="number"] {
  -moz-appearance: textfield;
  padding-left: 16px;
  position: relative;
}
.number-input-container {
  position: relative;
}
.number-input-container::before {
  content: '⇅';
  position: absolute;
  left: 6px;
  top: 50%;
  transform: translateY(-50%);
  color: #adb5bd;
  font-size: 10px;
  pointer-events: none;
  z-index: 1;
}
.remove-column {
  width: auto;
  min-width: 40px;
  max-width: 40px;
  flex: none;
  text-align: right;
  padding-right: 0.5rem;
}
/* Soft, gentle dropdown styling */
.dropdown-toggle {
  border: 1px solid #e2e8f0;
  background-color: #fafbfc;
  color: #475569;
  transition: all 0.2s ease;
  position: relative;
  padding-right: 2.5rem !important;
}
.dropdown-toggle:hover {
  border-color: #cbd5e1;
  background-color: #f1f5f9;
  color: #334155;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
.dropdown-toggle:focus {
  border-color: #11d6de;
  background-color: #ffffff;
  color: #334155;
  box-shadow: 0 0 0 0.2rem rgba(17, 214, 222, 0.15);
}
.dropdown-toggle::after {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  margin-left: 0;
}
.dropdown-toggle.is-invalid {
  border-color: #f87171;
  background-color: #fef2f2;
  padding-right: 2.75rem !important;
}
.dropdown-toggle.is-invalid::before {
  content: '⚠';
  position: absolute;
  right: 2rem;
  top: 50%;
  transform: translateY(-50%);
  color: #ef4444;
  font-size: 14px;
}
.dropdown-toggle.text-start {
  text-align: left !important;
}
.dropdown-menu {
  max-height: 220px;
  overflow-y: auto;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}
.dropdown-item {
  color: #475569;
  padding: 0.5rem 1rem;
  transition: all 0.15s ease;
}
.dropdown-item:hover,
.dropdown-item:focus {
  background-color: #f1f5f9;
  color: #334155;
}
.dropdown-item:active {
  background-color: #e2e8f0;
  color: #1e293b;
}

/* Gentle form control styling */
.form-control {
  border: 1px solid #e2e8f0;
  background-color: #fafbfc;
  color: #475569;
  transition: all 0.2s ease;
}
.form-control:hover {
  border-color: #cbd5e1;
  background-color: #f1f5f9;
}
.form-control:focus {
  border-color: #11d6de;
  background-color: #ffffff;
  color: #334155;
  box-shadow: 0 0 0 0.2rem rgba(17, 214, 222, 0.15);
}

/* Gentle button styling */
.btn-outline-primary {
  border-color: #11d6de;
  color: #114f68;
  background-color: transparent;
}
.btn-outline-primary:hover {
  background-color: #f0fdff;
  border-color: #06b6d4;
  color: #0e7490;
}

.btn-outline-secondary {
  border-color: #e2e8f0;
  color: #64748b;
  background-color: #fafbfc;
}
.btn-outline-secondary:hover {
  background-color: #f1f5f9;
  border-color: #cbd5e1;
  color: #475569;
}

.btn-outline-success {
  border-color: #86efac;
  color: #059669;
  background-color: #f0fdf4;
}
.btn-outline-success:hover {
  background-color: #dcfce7;
  border-color: #4ade80;
  color: #047857;
}

/* Soft card styling */
.bp-card {
  border: 1px solid #e2e8f0;
  background-color: #ffffff;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}
.bp-card-header {
  background-color: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
}

/* Remove harsh table hover effects */
.invoice-line:hover {
  background-color: #f8fafc;
  transition: background-color 0.15s ease;
}

/* Note label badge styling - matching settings page style */
.note-label-badge {
  cursor: pointer;
  font-weight: 500;
  font-size: 0.75rem;
  padding: 0.375rem 0.75rem;
  border-radius: 8px;
  transition: all 0.2s ease;
}

/* Unselected state - white background, blue border and text */
.note-label-badge.unselected {
  background-color: #ffffff !important;
  color: #114f68 !important;
  border: 1px solid #114f68 !important;
}

.note-label-badge.unselected:hover {
  background-color: rgba(17, 214, 222, 0.05) !important;
  border-color: #11D6DE !important;
}

/* Selected state - blue background, white text */
.note-label-badge.selected {
  background-color: #114f68 !important;
  color: #ffffff !important;
  border: 1px solid #114f68 !important;
}
</style>
{% endblock %}

{% block content %}
<section id="invoice-form" class="mb-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="fw-bold mb-1" style="font-size: 1.8rem;">{{ title }}</h1>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <!-- VAT Rate Selector Button -->
      <div class="dropdown">
        <button class="btn btn-sm bp-btn-cancel" type="button" id="vatRateSelector" data-bs-toggle="dropdown" aria-expanded="false">
          <span id="vatRateLabel">KM ({{ current_vat_rate.rate|vat_rate if current_vat_rate else 24 }}%)</span> <i class="bi bi-pencil-square ms-1"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="vatRateSelector" id="vatRateDropdown">
          {% for vr in vat_rates %}
          <li><a class="dropdown-item vat-rate-option{% if current_vat_rate and current_vat_rate.id == vr.id %} active{% elif not current_vat_rate and form.vat_rate_id.data|string == vr.id|string %} active{% endif %}" href="#" data-rate-id="{{ vr.id }}" data-rate="{{ vr.rate }}">{{ vr.name }} ({{ vr.rate|vat_rate }}%)</a></li>
          {% endfor %}
        </ul>
      </div>
      
      <!-- PDF Template Selector Button -->
      <div class="dropdown">
        <button class="btn btn-sm bp-btn-cancel" type="button" id="pdfTemplateSelector" data-bs-toggle="dropdown" aria-expanded="false">
          <span id="pdfTemplateLabel">PDF: Standard</span> <i class="bi bi-file-pdf ms-1"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="pdfTemplateSelector" id="pdfTemplateDropdown">
          <li><a class="dropdown-item pdf-template-option{% if form.pdf_template.data == 'standard' or not form.pdf_template.data %} active{% endif %}" href="#" data-template="standard">Standard</a></li>
          <li><a class="dropdown-item pdf-template-option{% if form.pdf_template.data == 'modern' %} active{% endif %}" href="#" data-template="modern">Modern</a></li>
          <li><a class="dropdown-item pdf-template-option{% if form.pdf_template.data == 'elegant' %} active{% endif %}" href="#" data-template="elegant">Elegant</a></li>
          <li><a class="dropdown-item pdf-template-option{% if form.pdf_template.data == 'minimal' %} active{% endif %}" href="#" data-template="minimal">Minimal</a></li>
          <li><a class="dropdown-item pdf-template-option{% if form.pdf_template.data == 'classic' %} active{% endif %}" href="#" data-template="classic">Classic</a></li>
        </ul>
      </div>
      
      <a href="{{ url_for('invoices.invoices') }}" class="btn btn-sm bp-btn-cancel" style="text-decoration: none;">
        <i class="bi bi-arrow-left me-1"></i>Tagasi arvetele
      </a>
    </div>
  </div>

  <form method="POST" id="invoiceForm" novalidate>
    {{ form.hidden_tag() }}
    
    <div class="row">
      <!-- Left Column - Invoice Details -->
      <div class="col-lg-9">
        <!-- Invoice Header -->
        <div class="bp-card mb-4">
          <div class="bp-card-header">
            <h2 class="h6 m-0">
              <i class="bi bi-file-earmark-text me-2"></i>Arve andmed
            </h2>
          </div>
          <div class="bp-card-body">
            <div class="row g-3">
              <!-- First Row: Invoice Number (50%) + Date (25%) + Due Date (25%) -->
              <div class="col-md-6">
                <label for="{{ form.number.id if form.number.id else 'number' }}" class="form-label">
                  {{ form.number.label.text if form.number.label else 'Arve number' }} <span class="text-danger">*</span>
                </label>
                {% if form.number.__call__ %}
                {{ form.number(class_="form-control" + (" is-invalid" if form.number.errors else ""), placeholder="Näiteks: 2025-0001") }}
                {% else %}
                <input type="text" 
                       name="{{ form.number.name or 'number' }}" 
                       id="{{ form.number.name or 'number' }}" 
                       class="form-control{{ " is-invalid" if form.number.errors else "" }}" 
                       placeholder="Näiteks: 2025-0001" 
                       value="{{ form.number.data or '' }}">
                {% endif %}
                {% if form.number.errors %}
                <div class="invalid-feedback">
                  {{ form.number.errors[0] }}
                </div>
                {% endif %}
              </div>
              
              <div class="col-md-3">
                <label for="{{ form.date.id if form.date.id else 'date' }}" class="form-label">
                  {{ form.date.label.text if form.date.label else 'Arve kuupäev' }} <span class="text-danger">*</span>
                </label>
                {% if form.date.__call__ %}
                {{ form.date(class_="form-control" + (" is-invalid" if form.date.errors else "")) }}
                {% else %}
                <input type="date" name="date" id="date" class="form-control{{ " is-invalid" if form.date.errors else "" }}" value="{{ form.date.data or '' }}">
                {% endif %}
                {% if form.date.errors %}
                <div class="invalid-feedback">
                  {% for error in form.date.errors %}{{ error }}{% endfor %}
                </div>
                {% endif %}
              </div>

              <div class="col-md-3">
                <label for="{{ form.due_date.id if form.due_date.id else 'due_date' }}" class="form-label">
                  {{ form.due_date.label.text if form.due_date.label else 'Maksetähtaeg' }} <span class="text-danger">*</span>
                </label>
                {% if form.due_date.__call__ %}
                {{ form.due_date(class_="form-control" + (" is-invalid" if form.due_date.errors else "")) }}
                {% else %}
                <input type="date" name="due_date" id="due_date" class="form-control{{ " is-invalid" if form.due_date.errors else "" }}" value="{{ form.due_date.data or '' }}">
                {% endif %}
                {% if form.due_date.errors %}
                <div class="invalid-feedback">
                  {% for error in form.due_date.errors %}{{ error }}{% endfor %}
                </div>
                {% endif %}
              </div>

              <!-- Second Row: Client (50%) + Payment Terms (50%) -->
              <div class="col-md-6">
                <label class="form-label">
                  Klient <span class="text-danger">*</span>
                </label>
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start{{ ' is-invalid' if form.client_id.errors else '' }}" type="button" id="clientSelector" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="clientLabel">Vali klient...</span>
                  </button>
                  <ul class="dropdown-menu w-100" aria-labelledby="clientSelector" id="clientDropdown">
                    <li><a class="dropdown-item client-option{% if not form.client_id.data %} active{% endif %}" href="#" data-client-id="">Vali klient...</a></li>
                    {% for client in clients %}
                    <li><a class="dropdown-item client-option{% if form.client_id.data|string == client.id|string %} active{% endif %}" href="#" data-client-id="{{ client.id }}" data-client-name="{{ client.name }}" data-client-email="{{ client.email }}">{{ client.name }}</a></li>
                    {% endfor %}
                  </ul>
                </div>
                <input type="hidden" name="client_id" id="client_id" value="{{ form.client_id.data or '' }}">
                {% if form.client_id.errors %}
                <div class="invalid-feedback">
                  {% for error in form.client_id.errors %}{{ error }}{% endfor %}
                </div>
                {% endif %}
                <div class="form-text">Vali klient, kellele arve saadetakse</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">
                  Makse tingimus
                </label>
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start{{ ' is-invalid' if form.payment_terms.errors else '' }}" type="button" id="paymentTermsSelector" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="paymentTermsLabel">Vali makse tingimus...</span>
                  </button>
                  <ul class="dropdown-menu w-100" aria-labelledby="paymentTermsSelector" id="paymentTermsDropdown">
                    <li><a class="dropdown-item payment-terms-option{% if not form.payment_terms.data %} active{% endif %}" href="#" data-terms-id="" data-terms-name="">Vali makse tingimus...</a></li>
                    {% for term in payment_terms %}
                    <li><a class="dropdown-item payment-terms-option{% if form.payment_terms.data == term.name %} active{% endif %}" href="#" data-terms-id="{{ term.id }}" data-terms-name="{{ term.name }}" data-terms-days="{{ term.days }}">{{ term.name }} ({{ term.days }} päeva)</a></li>
                    {% endfor %}
                  </ul>
                </div>
                <input type="hidden" name="payment_terms" id="payment_terms" value="{{ form.payment_terms.data or '' }}">
                {% if form.payment_terms.errors %}
                <div class="invalid-feedback">
                  {% for error in form.payment_terms.errors %}{{ error }}{% endfor %}
                </div>
                {% endif %}
              </div>

              <!-- Third Row: Client Extra Info (50%) + Note (50%) -->
              <div class="col-md-6">
                <label for="{{ form.client_extra_info.id if form.client_extra_info.id else 'client_extra_info' }}" class="form-label">
                  {{ form.client_extra_info.label.text if form.client_extra_info.label else 'Klienti lisainfo' }}
                </label>
                {% if form.client_extra_info.__call__ %}
                {{ form.client_extra_info(class_="form-control" + (" is-invalid" if form.client_extra_info.errors else ""), placeholder="Lisainfo kliendi kohta", rows="1") }}
                {% else %}
                <textarea name="{{ form.client_extra_info.name or 'client_extra_info' }}" 
                          id="{{ form.client_extra_info.name or 'client_extra_info' }}" 
                          class="form-control{{ " is-invalid" if form.client_extra_info.errors else "" }}" 
                          placeholder="Lisainfo kliendi kohta" 
                          rows="1">{{ form.client_extra_info.data if form.client_extra_info.data is not none else '' }}</textarea>
                {% endif %}
                {% if form.client_extra_info.errors %}
                <div class="invalid-feedback">
                  {{ form.client_extra_info.errors[0] }}
                </div>
                {% endif %}
              </div>

              <div class="col-md-6">
                <!-- Note Label Selection -->
                <div class="mb-2">
                  <label class="form-label">Märkuse tüüp</label>
                  <div class="d-flex flex-wrap gap-2" id="noteLabelBadges">
                    {% for label in note_labels %}
                    <span class="badge note-label-badge {% if default_note_label_id and label.id == default_note_label_id %}selected{% else %}unselected{% endif %}" 
                          data-label-id="{{ label.id }}" 
                          data-label-name="{{ label.name }}"
                          onclick="selectNoteLabel(this)">
                      {{ label.name }}
                    </span>
                    {% endfor %}
                  </div>
                  <!-- Hidden field to store selected note label ID -->
                  <input type="hidden" id="selectedNoteLabelId" name="selected_note_label_id" value="{{ default_note_label_id or '' }}">
                </div>
                
                <!-- Note Content -->
                <div>
                  {% if form.note.__call__ %}
                  {{ form.note(class_="form-control" + (" is-invalid" if form.note.errors else ""), placeholder="Sisesta märkuse sisu (valikuline)", rows="1", id="noteContent") }}
                  {% else %}
                  <textarea name="{{ form.note.name or 'note' }}" 
                            id="noteContent" 
                            class="form-control{{ " is-invalid" if form.note.errors else "" }}" 
                            placeholder="Sisesta märkuse sisu (valikuline)" 
                            rows="1">{{ form.note.data if form.note.data is not none else '' }}</textarea>
                  {% endif %}
                  {% if form.note.errors %}
                  <div class="invalid-feedback">
                    {{ form.note.errors[0] }}
                  </div>
                  {% endif %}
                </div>
              </div>

              <!-- Hidden fields -->
              {{ form.vat_rate_id(id="vat_rate_id", value=form.vat_rate_id.data or (current_vat_rate.id if current_vat_rate else '')) }}
              <input type="hidden" name="pdf_template" id="pdf_template" value="{{ form.pdf_template.data or 'standard' }}">
              
              <!-- Hidden Status field (will be handled separately if needed) -->
              {% if form.status %}
              <div class="d-none">
                {{ form.status() }}
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Invoice Lines -->
        <div class="bp-card">
          <div class="bp-card-header d-flex justify-content-between align-items-center">
            <h3 class="h6 m-0">
              <i class="bi bi-list-ul me-2"></i>Arve read
            </h3>
            <button type="button" class="btn btn-sm bp-btn-cancel" onclick="addInvoiceLine()">
              <i class="bi bi-plus-lg me-1"></i>Lisa rida
            </button>
          </div>
          <div class="bp-card-body p-0">
            <!-- Header Row -->
            <div class="row g-0 bg-light border-bottom py-2 px-3 fw-bold small text-muted">
              <div class="col">Kirjeldus</div>
              <div class="col-md-1 text-end">Kogus</div>
              <div class="col-md-2 text-end">Ühiku hind</div>
              <div class="col-md-2 text-end">Kokku</div>
              <div class="remove-column"></div>
            </div>
            <div id="invoice-lines-container">
              {% for line_form in form.lines %}
              <div class="invoice-line" data-line-index="{{ loop.index0 }}">
                {{ line_form.id() if line_form.id.__call__ else '' }}
                <div class="row g-2 align-items-center">
                  <div class="col">
                    {% if line_form.description.__call__ %}
                    {{ line_form.description(class_="form-control" + (" is-invalid" if line_form.description.errors else ""), placeholder="Teenuse või toote kirjeldus") }}
                    {% else %}
                    <input type="text" 
                           name="{{ line_form.description.name or 'lines-' + loop.index0|string + '-description' }}" 
                           id="{{ line_form.description.name or 'lines-' + loop.index0|string + '-description' }}" 
                           class="form-control{{ " is-invalid" if line_form.description.errors else "" }}" 
                           placeholder="Teenuse või toote kirjeldus"
                           value="{{ line_form.data.description if line_form.data and line_form.data.description else (line_form.description.data or '') }}">
                    {% endif %}
                  </div>
                  <div class="col-md-1">
                    <div class="number-input-container">
                      {% if line_form.qty.__call__ %}
                      {{ line_form.qty(class_="form-control line-qty" + (" is-invalid" if line_form.qty.errors else ""), placeholder="1", step="0.01") }}
                      {% else %}
                      <input type="number" 
                             name="{{ line_form.qty.name or 'lines-' + loop.index0|string + '-qty' }}" 
                             id="{{ line_form.qty.name or 'lines-' + loop.index0|string + '-qty' }}" 
                             class="form-control line-qty{{ " is-invalid" if line_form.qty.errors else "" }}" 
                             placeholder="1" 
                             step="0.01"
                             value="{{ line_form.data.qty if line_form.data and line_form.data.qty else (line_form.qty.data or '') }}">
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="input-group number-input-container">
                      {% if line_form.unit_price.__call__ %}
                      {{ line_form.unit_price(class_="form-control line-price" + (" is-invalid" if line_form.unit_price.errors else ""), placeholder="0.00", step="0.01") }}
                      {% else %}
                      <input type="number" 
                             name="{{ line_form.unit_price.name or 'lines-' + loop.index0|string + '-unit_price' }}" 
                             id="{{ line_form.unit_price.name or 'lines-' + loop.index0|string + '-unit_price' }}" 
                             class="form-control line-price{{ " is-invalid" if line_form.unit_price.errors else "" }}" 
                             placeholder="0.00" 
                             step="0.01"
                             value="{{ line_form.data.unit_price if line_form.data and line_form.data.unit_price else (line_form.unit_price.data or '') }}">
                      {% endif %}
                      <span class="input-group-text">€</span>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="fw-bold text-end line-total">0.00€</div>
                  </div>
                  <div class="remove-column">
                    <button type="button" class="btn btn-sm border-0 bg-transparent remove-line-btn" onclick="removeInvoiceLine(this)" title="Eemalda rida">
                    </button>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            
            {% if not form.lines.entries %}
            <div class="text-center py-4">
              <p class="text-muted mb-3">Arvele pole veel ridu lisatud</p>
              <button type="button" class="btn btn-primary" onclick="addInvoiceLine()">
                <i class="bi bi-plus-lg me-1"></i>Lisa esimene rida
              </button>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Info ja Teadaanded Section -->
        <div class="bp-card mt-4">
          <div class="bp-card-header">
            <h3 class="h6 m-0">
              <i class="bi bi-info-circle me-2"></i>Info ja Teadaanded
            </h3>
          </div>
          <div class="bp-card-body">
            <div class="row">
              <div class="col-md-12">
                <label for="{{ form.announcements.id if form.announcements.id else 'announcements' }}" class="form-label">
                  {{ form.announcements.label.text if form.announcements.label else 'Teadaanded' }}
                </label>
                {% if form.announcements.__call__ %}
                {{ form.announcements(class_="form-control" + (" is-invalid" if form.announcements.errors else ""), placeholder="Lisainfo, teadaanded või märkused arve kohta", rows="3") }}
                {% else %}
                <textarea name="{{ form.announcements.name or 'announcements' }}" 
                          id="{{ form.announcements.name or 'announcements' }}" 
                          class="form-control{{ " is-invalid" if form.announcements.errors else "" }}" 
                          placeholder="Lisainfo, teadaanded või märkused arve kohta" 
                          rows="3">{{ form.announcements.data if form.announcements.data is not none else '' }}</textarea>
                {% endif %}
                {% if form.announcements.errors %}
                <div class="invalid-feedback">
                  {{ form.announcements.errors[0] }}
                </div>
                {% endif %}
                <div class="form-text">Vabas vormis tekstiväli täiendava info jaoks</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Invoice Summary -->
      <div class="col-lg-3">
        <!-- Invoice Totals -->
        <div class="bp-card invoice-totals mb-4">
          <div class="bp-card-header">
            <h3 class="h6 m-0">
              <i class="bi bi-calculator me-2"></i>Arve kokkuvõte
            </h3>
          </div>
          <div class="bp-card-body">
            <table class="table table-borderless mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Vahesumma:</td>
                  <td class="text-end" id="subtotal">0.00€</td>
                </tr>
                <tr>
                  <td class="text-muted">KM (<span id="vat-rate-display">24</span>%):</td>
                  <td class="text-end" id="vat-amount">0.00€</td>
                </tr>
                <tr class="border-top">
                  <td class="fw-bold">Kokku:</td>
                  <td class="text-end fw-bold fs-5" id="total-amount">0.00€</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="bp-card">
          <div class="bp-card-body">
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i>
                {% if invoice %}Uuenda arvet{% else %}Loo arve{% endif %}
              </button>
              
              {% if invoice and invoice.status == 'mustand' %}
              <button type="button" class="btn btn-success" onclick="submitAndSend()">
                <i class="bi bi-send me-1"></i>Salvesta ja saada
              </button>
              {% endif %}
              
              <a href="{{ url_for('invoices.invoices') }}" class="btn btn-sm bp-btn-cancel" style="text-decoration: none;">
                <i class="bi bi-x-lg me-1"></i>Tühista
              </a>
            </div>
          </div>
        </div>

        <!-- Invoice Tips -->
        <div class="bp-card mt-4">
          <div class="bp-card-header">
            <h4 class="h6 m-0">
              <i class="bi bi-lightbulb me-2"></i>Nõuanded
            </h4>
          </div>
          <div class="bp-card-body">
            <ul class="list-unstyled small mb-0">
              <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Kontrolli kliendi kontaktandmeid</li>
              <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Lisa selged teenuste kirjeldused</li>
              <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Määra maksetähtaeg (soovitavalt 14 päeva)</li>
              <li><i class="bi bi-check-circle text-success me-2"></i>Salvesta enne saatmist mustandina</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </form>
</section>

<!-- Line Template (hidden) -->
<div id="line-template" class="d-none">
  <div class="invoice-line" data-line-index="">
    <input type="hidden" name="lines-{index}-id" value="">
    <input type="hidden" name="lines-{index}-line_total" value="" class="line-total-input">
    <div class="row g-2 align-items-center">
      <div class="col">
        <input type="text" name="lines-{index}-description" class="form-control" placeholder="Teenuse või toote kirjeldus">
      </div>
      <div class="col-md-1">
        <div class="number-input-container">
          <input type="number" name="lines-{index}-qty" class="form-control line-qty" placeholder="1" step="0.01">
        </div>
      </div>
      <div class="col-md-2">
        <div class="input-group number-input-container">
          <input type="number" name="lines-{index}-unit_price" class="form-control line-price" placeholder="0.00" step="0.01">
          <span class="input-group-text">€</span>
        </div>
      </div>
      <div class="col-md-2">
        <div class="fw-bold text-end line-total">0.00€</div>
      </div>
      <div class="remove-column">
        <button type="button" class="btn btn-sm border-0 bg-transparent remove-line-btn" onclick="removeInvoiceLine(this)" title="Eemalda rida">
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let lineIndex = {{ form.lines|length or 0 }};

// VAT rate mapping (ID -> rate percentage)
const vatRateMap = {
  {% for vr in vat_rates %}
  {{ vr.id }}: {{ vr.rate }},
  {% endfor %}
};

// Payment terms mapping (name -> days)
const paymentTermsMap = {
  {% for pt in payment_terms %}
  '{{ pt.name }}': {{ pt.days }},
  {% endfor %}
};


// Get next available line index
function getNextLineIndex() {
  const container = document.getElementById('invoice-lines-container');
  const existingLines = container.querySelectorAll('.invoice-line');
  let maxIndex = -1;
  
  existingLines.forEach(line => {
    const nameAttr = line.querySelector('input[name*="lines-"]')?.getAttribute('name');
    if (nameAttr) {
      const match = nameAttr.match(/lines-(\d+)-/);
      if (match) {
        maxIndex = Math.max(maxIndex, parseInt(match[1]));
      }
    }
  });
  
  return maxIndex + 1;
}

// Add new invoice line
function addInvoiceLine() {
  const container = document.getElementById('invoice-lines-container');
  const template = document.getElementById('line-template');
  const newLine = template.cloneNode(true);
  
  const currentIndex = getNextLineIndex();
  
  newLine.removeAttribute('id');
  newLine.classList.remove('d-none');
  newLine.setAttribute('data-line-index', currentIndex);
  
  // Update form field names and ids
  const inputs = newLine.querySelectorAll('input');
  inputs.forEach(input => {
    const name = input.getAttribute('name');
    if (name) {
      input.setAttribute('name', name.replace('{index}', currentIndex));
      input.setAttribute('id', name.replace('{index}', currentIndex).replace('-', '_'));
    }
  });
  
  // Update labels
  const labels = newLine.querySelectorAll('label');
  labels.forEach(label => {
    const forAttr = label.getAttribute('for');
    if (forAttr) {
      label.setAttribute('for', forAttr.replace('{index}', currentIndex).replace('-', '_'));
    }
  });
  
  container.appendChild(newLine.firstElementChild);
  
  // Add event listeners
  addLineEventListeners(container.lastElementChild);
  
  updateTotals();
}

// Remove invoice line
function removeInvoiceLine(button) {
  const line = button.closest('.invoice-line');
  const container = document.getElementById('invoice-lines-container');
  
  // Check if this line has an existing ID (meaning it exists in database)
  const idField = line.querySelector('input[name$="-id"]');
  if (idField && idField.value) {
    // Mark for deletion instead of removing DOM element
    line.style.display = 'none';
    line.classList.add('marked-for-deletion');
    
    // Add a hidden field to indicate deletion
    const deleteField = document.createElement('input');
    deleteField.type = 'hidden';
    deleteField.name = idField.name.replace('-id', '-delete');
    deleteField.value = 'true';
    line.appendChild(deleteField);
  } else {
    // New line that hasn't been saved yet - safe to remove completely
    line.remove();
  }
  
  // If no visible lines left, add an empty one
  const visibleLines = container.querySelectorAll('.invoice-line:not(.marked-for-deletion)');
  if (visibleLines.length === 0) {
    addInvoiceLine();
  }
  
  updateTotals();
}

// Add event listeners to line inputs
function addLineEventListeners(line) {
  const qtyInput = line.querySelector('.line-qty');
  const priceInput = line.querySelector('.line-price');
  
  [qtyInput, priceInput].forEach(input => {
    if (input) {
      input.addEventListener('input', updateTotals);
      input.addEventListener('blur', updateTotals);
      input.addEventListener('change', updateTotals);
      input.addEventListener('keyup', updateTotals);
    }
  });
  
  // Add validation listeners
  addLineValidation(line);
}

// Precision calculation helpers to match backend logic
function preciseRound(value, decimals = 2) {
  // Emulate Python's Decimal ROUND_HALF_UP behavior in JavaScript
  const factor = Math.pow(10, decimals);
  return Math.round((value + Number.EPSILON) * factor) / factor;
}

function formatCurrency(value) {
  // Format number with thousand separators for better readability
  if (value == null) return '0.00';
  return parseFloat(value).toLocaleString('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).replace(/,/g, ' ');
}

function calculateLineTotal(qty, unitPrice) {
  // Match backend calculate_line_total precision
  if (!qty || !unitPrice) return 0;
  const lineTotal = qty * unitPrice;
  return preciseRound(lineTotal, 2);
}

function calculateVatAmount(subtotal, vatRate) {
  // Match backend calculate_vat_amount precision
  if (!subtotal || vatRate == null || vatRate === undefined) return 0;
  const vatAmount = subtotal * (vatRate / 100);
  return preciseRound(vatAmount, 2);
}

// Update invoice totals
function updateTotals() {
  let subtotal = 0;
  
  // Calculate line totals (skip hidden/deleted lines)
  document.querySelectorAll('.invoice-line:not(.marked-for-deletion)').forEach(line => {
    const qty = parseFloat(line.querySelector('.line-qty')?.value) || 0;
    const price = parseFloat(line.querySelector('.line-price')?.value) || 0;
    const lineTotal = calculateLineTotal(qty, price);  // Use precise calculation
    
    // Update display
    const lineTotalDisplay = line.querySelector('.line-total');
    if (lineTotalDisplay) {
      lineTotalDisplay.textContent = formatCurrency(lineTotal) + '€';
    }
    
    // Update hidden field
    const lineTotalInput = line.querySelector('.line-total-input');
    if (lineTotalInput) {
      lineTotalInput.value = lineTotal.toFixed(2);
    }
    
    subtotal = preciseRound(subtotal + lineTotal, 2);  // Accumulate with precision
  });
  
  // Get VAT rate from global variable
  const vatRateId = parseInt(vatRateHiddenField?.value);
  const vatRate = vatRateId && vatRateMap.hasOwnProperty(vatRateId) ? vatRateMap[vatRateId] : 24;
  
  // Debug: uncomment for troubleshooting
  // console.log('UpdateTotals debug:', {
  //   vatRateHiddenFieldValue: vatRateHiddenField?.value,
  //   vatRateId: vatRateId,
  //   vatRate: vatRate,
  //   subtotal: subtotal.toFixed(2)
  // });
  
  // Calculate VAT amount with precision
  const vatAmount = calculateVatAmount(subtotal, vatRate);
  const total = preciseRound(subtotal + vatAmount, 2);
  
  // Update displays
  const subtotalElement = document.getElementById('subtotal');
  const vatAmountElement = document.getElementById('vat-amount');
  const totalAmountElement = document.getElementById('total-amount');
  const vatRateDisplayElement = document.getElementById('vat-rate-display');
  
  if (subtotalElement) subtotalElement.textContent = formatCurrency(subtotal) + '€';
  if (vatRateDisplayElement) vatRateDisplayElement.textContent = vatRate.toString();
  if (vatAmountElement) vatAmountElement.textContent = formatCurrency(vatAmount) + '€';
  if (totalAmountElement) totalAmountElement.textContent = formatCurrency(total) + '€';
  
  // Debug output (uncomment for debugging)
  // console.log('Precise totals:', { 
  //   subtotal: subtotal.toFixed(2), 
  //   vatRate: vatRate, 
  //   vatAmount: vatAmount.toFixed(2), 
  //   total: total.toFixed(2) 
  // });
}

// Submit and send function
function submitAndSend() {
  const statusField = document.getElementById('status');
  statusField.value = 'saadetud';
  document.getElementById('invoiceForm').submit();
}

// Global variables for form elements
let vatRateHiddenField, clientHiddenField, paymentTermsHiddenField, pdfTemplateHiddenField;
let vatRateLabel, clientLabel, paymentTermsLabel, pdfTemplateLabel;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Get all the form elements
  vatRateHiddenField = document.getElementById('vat_rate_id');
  clientHiddenField = document.getElementById('client_id');  
  paymentTermsHiddenField = document.getElementById('payment_terms');
  pdfTemplateHiddenField = document.getElementById('pdf_template');
  
  vatRateLabel = document.getElementById('vatRateLabel');
  clientLabel = document.getElementById('clientLabel');
  paymentTermsLabel = document.getElementById('paymentTermsLabel');  
  pdfTemplateLabel = document.getElementById('pdfTemplateLabel');
  
  // Bootstrap dropdowns initialize automatically, no need for manual init
  
  // Add event listeners to existing lines
  document.querySelectorAll('.invoice-line').forEach(line => {
    addLineEventListeners(line);
  });
  
  // VAT rate selector dropdown functionality
  const vatRateOptions = document.querySelectorAll('.vat-rate-option');
  const vatRateDropdown = document.getElementById('vatRateDropdown');
  
  // Use event delegation instead of individual listeners
  if (vatRateDropdown) {
    vatRateDropdown.addEventListener('click', function(e) {
      const clickedOption = e.target.closest('.vat-rate-option');
      if (clickedOption) {
        e.preventDefault();
        const rateId = clickedOption.getAttribute('data-rate-id');
        const rate = clickedOption.getAttribute('data-rate');
        
        // Update hidden field
        if (vatRateHiddenField) {
          vatRateHiddenField.value = rateId;
          console.log('VAT Rate Selection - Updated hidden field:', {
            rateId: rateId,
            fieldName: vatRateHiddenField.name,
            fieldValue: vatRateHiddenField.value,
            rate: rate
          });
          
          // Trigger change event to ensure form frameworks detect the change
          vatRateHiddenField.dispatchEvent(new Event('change', { bubbles: true }));
        } else {
          console.error('VAT rate hidden field not found!');
        }
        
        // Update button text
        if (vatRateLabel) {
          vatRateLabel.textContent = `KM (${rate}%)`;
        }
        
        // Update active state
        vatRateOptions.forEach(opt => opt.classList.remove('active'));
        clickedOption.classList.add('active');
        
        // Update totals
        updateTotals();
      }
    });
  }
  
  // PDF template selector dropdown functionality
  const pdfTemplateOptions = document.querySelectorAll('.pdf-template-option');
  const pdfTemplateDropdown = document.getElementById('pdfTemplateDropdown');
  
  if (pdfTemplateDropdown) {
    pdfTemplateDropdown.addEventListener('click', function(e) {
      const clickedOption = e.target.closest('.pdf-template-option');
      if (clickedOption) {
        e.preventDefault();
        const template = clickedOption.getAttribute('data-template');
        const templateText = clickedOption.textContent.trim();
        
        // Update hidden field
        if (pdfTemplateHiddenField) {
          pdfTemplateHiddenField.value = template;
        }
        
        // Update button text
        if (pdfTemplateLabel) {
          const templateName = templateText.split(' - ')[0];
          pdfTemplateLabel.textContent = `PDF: ${templateName}`;
        }
        
        // Update active state
        pdfTemplateOptions.forEach(opt => opt.classList.remove('active'));
        clickedOption.classList.add('active');
      }
    });
  }
  
  // Client selector dropdown functionality
  const clientOptions = document.querySelectorAll('.client-option');
  const clientDropdown = document.getElementById('clientDropdown');
  
  if (clientDropdown) {
    clientDropdown.addEventListener('click', function(e) {
      const clickedOption = e.target.closest('.client-option');
      if (clickedOption) {
        e.preventDefault();
        const clientId = clickedOption.getAttribute('data-client-id');
        const clientName = clickedOption.getAttribute('data-client-name');
        const clientEmail = clickedOption.getAttribute('data-client-email');
        
        // Update hidden field
        if (clientHiddenField) {
          clientHiddenField.value = clientId;
        }
        
        // Update button text
        if (clientLabel) {
          if (clientId && clientName) {
            clientLabel.textContent = clientName;
          } else {
            clientLabel.textContent = 'Vali klient...';
          }
        }
        
        // Update active state
        clientOptions.forEach(opt => opt.classList.remove('active'));
        clickedOption.classList.add('active');
        
        // Clear validation state
        const clientButton = document.getElementById('clientSelector');
        if (clientButton && clientId) {
          clientButton.classList.remove('is-invalid');
        }
      }
    });
  }
  
  // Payment terms selector dropdown functionality
  const paymentTermsOptions = document.querySelectorAll('.payment-terms-option');
  const paymentTermsDropdown = document.getElementById('paymentTermsDropdown');
  
  if (paymentTermsDropdown) {
    paymentTermsDropdown.addEventListener('click', function(e) {
      const clickedOption = e.target.closest('.payment-terms-option');
      if (clickedOption) {
        e.preventDefault();
        const termsId = clickedOption.getAttribute('data-terms-id');
        const termsName = clickedOption.getAttribute('data-terms-name');
        const termsDays = clickedOption.getAttribute('data-terms-days');
        
        // Update hidden field
        if (paymentTermsHiddenField) {
          paymentTermsHiddenField.value = termsName;
        }
        
        // Update button text
        if (paymentTermsLabel) {
          if (termsName) {
            paymentTermsLabel.textContent = `${termsName} (${termsDays} päeva)`;
          } else {
            paymentTermsLabel.textContent = 'Vali makse tingimus...';
          }
        }
        
        // Update active state
        paymentTermsOptions.forEach(opt => opt.classList.remove('active'));
        clickedOption.classList.add('active');
        
        // Auto-update due date when payment terms change
        if (dateInput && dueDateInput && dateInput.value) {
          calculateDueDate();
        }
      }
    });
  }
  
  // Auto-fill due date based on invoice date and payment terms
  const dateInput = document.getElementById('date');
  const dueDateInput = document.getElementById('due_date');
  
  // Function to calculate due date based on invoice date and payment terms
  function calculateDueDate() {
    const invoiceDate = dateInput.value;
    if (!invoiceDate) return;
    
    const paymentTermsHiddenField = document.getElementById('payment_terms');
    const paymentTerms = paymentTermsHiddenField ? paymentTermsHiddenField.value : '';
    
    // Use proper undefined check instead of || to handle 0 days correctly
    const days = paymentTermsMap.hasOwnProperty(paymentTerms) ? paymentTermsMap[paymentTerms] : 14;
    
    const invoiceDateObj = new Date(invoiceDate);
    const dueDate = new Date(invoiceDateObj.getTime() + (days * 24 * 60 * 60 * 1000));
    dueDateInput.value = dueDate.toISOString().split('T')[0];
  }
  
  if (dateInput && dueDateInput) {
    // Update due date when invoice date changes
    dateInput.addEventListener('change', function() {
      if (this.value) {
        calculateDueDate();
      }
    });
  }
  
  // Enhanced form validation
  const form = document.getElementById('invoiceForm');
  form.addEventListener('submit', function(event) {
    // Debug form submission
    console.log('Form submission - VAT rate field value:', vatRateHiddenField?.value);
    console.log('Form submission - VAT rate field name:', vatRateHiddenField?.name);
    
    // Log all form data for debugging
    const formData = new FormData(form);
    const formDataObj = {};
    for (let [key, value] of formData.entries()) {
      formDataObj[key] = value;
    }
    console.log('All form data before submit:', formDataObj);
    
    // Specifically log VAT rate data
    console.log('VAT Rate Debugging:', {
      hiddenFieldValue: vatRateHiddenField?.value,
      formDataVatRate: formData.get('vat_rate_id'),
      currentDisplayRate: document.getElementById('vat-rate-display')?.textContent,
      activeVatOption: document.querySelector('.vat-rate-option.active')?.getAttribute('data-rate-id')
    });
    
    let isValid = true;
    let errorMessages = [];
    
    // Check required fields
    const clientSelect = document.getElementById('client_id');
    const clientButton = document.getElementById('clientSelector');
    if (!clientSelect.value) {
      errorMessages.push('Klient on kohustuslik');
      if (clientButton) clientButton.classList.add('is-invalid');
      isValid = false;
    }
    
    const dateInput = document.getElementById('date');
    if (!dateInput.value) {
      errorMessages.push('Arve kuupäev on kohustuslik');
      dateInput.classList.add('is-invalid');
      isValid = false;
    }
    
    const dueDateInput = document.getElementById('due_date');
    if (!dueDateInput.value) {
      errorMessages.push('Maksetähtaeg on kohustuslik');
      dueDateInput.classList.add('is-invalid');
      isValid = false;
    }
    
    // Check if at least one line has complete data (skip hidden/deleted lines)
    const lines = document.querySelectorAll('.invoice-line:not(.marked-for-deletion)');
    let hasValidLine = false;
    let incompleteLines = 0;
    
    lines.forEach(line => {
      const description = line.querySelector('input[name*="description"]')?.value?.trim();
      const qty = line.querySelector('input[name*="qty"]')?.value;
      const price = line.querySelector('input[name*="unit_price"]')?.value;
      
      if (description && qty && price) {
        hasValidLine = true;
      } else if (description || qty || price) {
        // Partially filled line
        incompleteLines++;
        if (!description) line.querySelector('input[name*="description"]').classList.add('is-invalid');
        if (!qty) line.querySelector('input[name*="qty"]').classList.add('is-invalid');
        if (!price) line.querySelector('input[name*="unit_price"]').classList.add('is-invalid');
      }
    });
    
    if (!hasValidLine) {
      errorMessages.push('Palun lisa vähemalt üks täielik arve rida');
      isValid = false;
    } else if (incompleteLines > 0) {
      errorMessages.push('Mõnel arve real on andmed puudulikud');
      isValid = false;
    }
    
    // Show validation errors
    if (!isValid) {
      event.preventDefault();
      
      const errorMessage = errorMessages.join('. ') + '.';
      if (window.BilliPocket && window.BilliPocket.showMessage) {
        window.BilliPocket.showMessage(errorMessage, 'error');
      } else {
        alert(errorMessage);
      }
      
      // Focus on first error field
      const firstError = form.querySelector('.is-invalid');
      if (firstError) {
        firstError.focus();
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    
    return isValid;
  });
  
  // Initialize VAT rate display on page load
  console.log('VAT rate initialization - Hidden field:', vatRateHiddenField);
  console.log('VAT rate initialization - Hidden field value:', vatRateHiddenField?.value);
  console.log('VAT rate initialization - VAT rate map:', vatRateMap);
  
  if (vatRateHiddenField && vatRateHiddenField.value && vatRateLabel) {
    const currentVatRateId = parseInt(vatRateHiddenField.value);
    const currentVatRate = vatRateMap[currentVatRateId];
    console.log('VAT rate initialization - Current rate ID:', currentVatRateId, 'Rate:', currentVatRate);
    
    if (currentVatRate) {
      vatRateLabel.textContent = `KM (${currentVatRate}%)`;
      // Set active class on correct option
      const activeVatOption = document.querySelector(`.vat-rate-option[data-rate-id="${currentVatRateId}"]`);
      if (activeVatOption) {
        document.querySelectorAll('.vat-rate-option').forEach(opt => opt.classList.remove('active'));
        activeVatOption.classList.add('active');
        console.log('VAT rate initialization - Set active option:', activeVatOption);
      } else {
        console.warn('VAT rate initialization - Active option not found for ID:', currentVatRateId);
      }
    } else {
      console.warn('VAT rate initialization - Rate not found in map for ID:', currentVatRateId);
    }
  } else {
    console.log('VAT rate initialization - Skipped:', {
      hasField: !!vatRateHiddenField,
      hasValue: !!vatRateHiddenField?.value,
      hasLabel: !!vatRateLabel
    });
  }
  
  // Initialize PDF template display on page load
  if (pdfTemplateHiddenField && pdfTemplateLabel) {
    const currentTemplate = pdfTemplateHiddenField.value || 'standard';
    const templateNames = {
      'standard': 'Standard',
      'modern': 'Modern',
      'elegant': 'Elegant', 
      'minimal': 'Minimal',
      'classic': 'Classic'
    };
    const templateName = templateNames[currentTemplate] || 'Standard';
    pdfTemplateLabel.textContent = `PDF: ${templateName}`;
    // Set active class on correct option
    const activePdfOption = document.querySelector(`.pdf-template-option[data-template="${currentTemplate}"]`);
    if (activePdfOption) {
      document.querySelectorAll('.pdf-template-option').forEach(opt => opt.classList.remove('active'));
      activePdfOption.classList.add('active');
    }
  }
  
  // Initialize client display on page load
  if (clientHiddenField && clientHiddenField.value && clientLabel) {
    const currentClientId = clientHiddenField.value;
    const clientOption = document.querySelector(`.client-option[data-client-id="${currentClientId}"]`);
    if (clientOption) {
      const clientName = clientOption.getAttribute('data-client-name');
      const clientEmail = clientOption.getAttribute('data-client-email');
      if (clientName) {
        clientLabel.textContent = clientName;
        // Set active class on correct option
        document.querySelectorAll('.client-option').forEach(opt => opt.classList.remove('active'));
        clientOption.classList.add('active');
      }
    }
  }
  
  // Initialize payment terms display on page load
  if (paymentTermsHiddenField && paymentTermsHiddenField.value && paymentTermsLabel) {
    const currentPaymentTerms = paymentTermsHiddenField.value;
    const paymentTermsOption = document.querySelector(`.payment-terms-option[data-terms-name="${currentPaymentTerms}"]`);
    if (paymentTermsOption) {
      const termsName = paymentTermsOption.getAttribute('data-terms-name');
      const termsDays = paymentTermsOption.getAttribute('data-terms-days');
      if (termsName) {
        paymentTermsLabel.textContent = `${termsName} (${termsDays} päeva)`;
        // Set active class on correct option
        document.querySelectorAll('.payment-terms-option').forEach(opt => opt.classList.remove('active'));
        paymentTermsOption.classList.add('active');
      }
    }
  }
  
  // Initial totals calculation (with delay to ensure all form fields are loaded)
  setTimeout(() => {
    // Debug: uncomment for troubleshooting
    // console.log('Initializing totals calculation...');
    // console.log('VAT rate field:', vatRateHiddenField, vatRateHiddenField?.value);
    // console.log('VAT rate map:', vatRateMap);
    updateTotals();
  }, 250);
  
  // Initialize note label badge selection on page load with delay to ensure proper initialization
  setTimeout(() => {
    const hiddenNoteLabelField = document.getElementById('selectedNoteLabelId');
    if (hiddenNoteLabelField && hiddenNoteLabelField.value) {
      const selectedBadge = document.querySelector(`.note-label-badge[data-label-id="${hiddenNoteLabelField.value}"]`);
      if (selectedBadge) {
        // Ensure the badge is properly marked as selected without triggering side effects
        const allBadges = document.querySelectorAll('.note-label-badge');
        allBadges.forEach(badge => {
          badge.classList.remove('selected');
          badge.classList.add('unselected');
        });
        
        selectedBadge.classList.remove('unselected');
        selectedBadge.classList.add('selected');
        
        // Update placeholder text
        const noteContent = document.getElementById('noteContent');
        if (noteContent) {
          noteContent.placeholder = `Sisesta ${selectedBadge.getAttribute('data-label-name').toLowerCase()} sisu`;
        }
      }
    }
  }, 150);
  
  // Auto-focus first empty field
  const firstEmptyInput = document.querySelector('input:not([type="hidden"]):not([readonly]):not([disabled])');
  if (firstEmptyInput && !firstEmptyInput.value) {
    firstEmptyInput.focus();
  }
});

// Real-time validation feedback
document.querySelectorAll('input, select, textarea').forEach(function(field) {
  field.addEventListener('blur', function() {
    // Clear validation state first
    this.classList.remove('is-invalid', 'is-valid');
    
    if (this.checkValidity() && this.value.trim()) {
      this.classList.add('is-valid');
    } else if (!this.checkValidity() || (this.required && !this.value.trim())) {
      this.classList.add('is-invalid');
    }
  });
  
  field.addEventListener('input', function() {
    if (this.classList.contains('is-invalid')) {
      if (this.checkValidity() && (!this.required || this.value.trim())) {
        this.classList.remove('is-invalid');
        if (this.value.trim()) {
          this.classList.add('is-valid');
        }
      }
    }
  });
});

// Enhanced line input validation
function addLineValidation(line) {
  const inputs = line.querySelectorAll('input[type="text"], input[type="number"]');
  inputs.forEach(input => {
    input.addEventListener('input', function() {
      // Remove invalid state when user starts typing
      if (this.classList.contains('is-invalid')) {
        this.classList.remove('is-invalid');
      }
    });
  });
}

// Note Label Badge Selection
function selectNoteLabel(selectedBadge) {
  // Check if the clicked badge is already selected
  const isAlreadySelected = selectedBadge.classList.contains('selected');
  
  if (isAlreadySelected) {
    // If already selected, deselect it
    deselectNoteLabel();
    return;
  }
  
  // Get all badge elements
  const allBadges = document.querySelectorAll('.note-label-badge');
  
  // Remove selection from all badges
  allBadges.forEach(badge => {
    badge.classList.remove('selected');
    badge.classList.add('unselected');
  });
  
  // Add selection to clicked badge
  selectedBadge.classList.remove('unselected');
  selectedBadge.classList.add('selected');
  
  // Update hidden field with selected label ID
  const hiddenField = document.getElementById('selectedNoteLabelId');
  if (hiddenField) {
    hiddenField.value = selectedBadge.getAttribute('data-label-id');
  }
  
  // Update placeholder text
  const noteContent = document.getElementById('noteContent');
  if (noteContent) {
    noteContent.placeholder = `Sisesta ${selectedBadge.getAttribute('data-label-name').toLowerCase()} sisu`;
  }
}

// Deselect note label function
function deselectNoteLabel() {
  // Get all badge elements
  const allBadges = document.querySelectorAll('.note-label-badge');
  
  // Remove selection from all badges
  allBadges.forEach(badge => {
    badge.classList.remove('selected');
    badge.classList.add('unselected');
  });
  
  // Clear hidden field
  const hiddenField = document.getElementById('selectedNoteLabelId');
  if (hiddenField) {
    hiddenField.value = '';
  }
  
  // Reset placeholder text to generic
  const noteContent = document.getElementById('noteContent');
  if (noteContent) {
    noteContent.placeholder = 'Sisesta märkuse sisu (valikuline)';
  }
}

</script>
{% endblock %}