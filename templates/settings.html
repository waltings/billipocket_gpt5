{% extends 'layout.html' %}
{% block title %}Seaded – Billipocket{% endblock %}
{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="fw-bold mb-1" style="font-size: 1.8rem;">Seaded</h1>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-primary" type="submit" form="settingsForm">
      <i class="bi bi-check-lg me-1"></i>Salvesta seaded
    </button>
  </div>
</div>

<form method="POST" id="settingsForm">
  {{ form.hidden_tag() }}
  
  <!-- Ettevõtte kaart -->
  <div class="bp-card mb-4">
    <div class="bp-card-header">
      <h2 class="h6 m-0"><i class="bi bi-building me-2"></i>Ettevõtte kaart</h2>
    </div>
    <div class="bp-card-body">
      <div class="row g-3">
        <!-- Esimene veerg -->
        <div class="col-md-4">
          <!-- Ettevõtte nimi -->
          <div class="mb-3">
            <label for="{{ form.company_name.id }}" class="form-label">
              {{ form.company_name.label.text }} <span class="text-danger">*</span>
            </label>
            {{ form.company_name(class_="form-control" + (" is-invalid" if form.company_name.errors else "")) }}
            {% if form.company_name.errors %}
            <div class="invalid-feedback">
              {{ form.company_name.errors[0] }}
            </div>
            {% endif %}
          </div>
          
          <!-- Aadress -->
          <div class="mb-3">
            <label for="{{ form.company_address.id }}" class="form-label">
              {{ form.company_address.label.text }}
            </label>
            {{ form.company_address(class_="form-control" + (" is-invalid" if form.company_address.errors else ""), rows="3") }}
            {% if form.company_address.errors %}
            <div class="invalid-feedback">
              {{ form.company_address.errors[0] }}
            </div>
            {% endif %}
          </div>
          
          <!-- Telefon -->
          <div class="mb-3">
            <label for="{{ form.company_phone.id }}" class="form-label">
              {{ form.company_phone.label.text }}
            </label>
            {{ form.company_phone(class_="form-control" + (" is-invalid" if form.company_phone.errors else "")) }}
            {% if form.company_phone.errors %}
            <div class="invalid-feedback">
              {{ form.company_phone.errors[0] }}
            </div>
            {% endif %}
          </div>
          
          <!-- Email -->
          <div class="mb-3">
            <label for="{{ form.company_email.id }}" class="form-label">
              {{ form.company_email.label.text }}
            </label>
            {{ form.company_email(class_="form-control" + (" is-invalid" if form.company_email.errors else ""), type="email") }}
            {% if form.company_email.errors %}
            <div class="invalid-feedback">
              {{ form.company_email.errors[0] }}
            </div>
            {% endif %}
          </div>
          
          <!-- Koduleht -->
          <div class="mb-3">
            <label for="{{ form.company_website.id }}" class="form-label">
              {{ form.company_website.label.text }}
            </label>
            {{ form.company_website(class_="form-control" + (" is-invalid" if form.company_website.errors else ""), placeholder="https://www.example.com") }}
            {% if form.company_website.errors %}
            <div class="invalid-feedback">
              {{ form.company_website.errors[0] }}
            </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Teine veerg -->
        <div class="col-md-4">
          <!-- Registrikood -->
          <div class="mb-3">
            <label for="{{ form.company_registry_code.id }}" class="form-label">
              {{ form.company_registry_code.label.text }}
            </label>
            {{ form.company_registry_code(class_="form-control" + (" is-invalid" if form.company_registry_code.errors else "")) }}
            {% if form.company_registry_code.errors %}
            <div class="invalid-feedback">
              {{ form.company_registry_code.errors[0] }}
            </div>
            {% endif %}
          </div>
          
          <!-- Käibemaksu number -->
          <div class="mb-3">
            <label for="{{ form.company_vat_number.id }}" class="form-label">
              {{ form.company_vat_number.label.text }}
            </label>
            {{ form.company_vat_number(class_="form-control" + (" is-invalid" if form.company_vat_number.errors else "")) }}
            {% if form.company_vat_number.errors %}
            <div class="invalid-feedback">
              {{ form.company_vat_number.errors[0] }}
            </div>
            {% endif %}
          </div>
          
          <!-- Pank -->
          <div class="mb-3">
            <label for="{{ form.company_bank.id }}" class="form-label">
              {{ form.company_bank.label.text }}
            </label>
            {{ form.company_bank(class_="form-control" + (" is-invalid" if form.company_bank.errors else "")) }}
            {% if form.company_bank.errors %}
            <div class="invalid-feedback">
              {{ form.company_bank.errors[0] }}
            </div>
            {% endif %}
          </div>
          
          <!-- Pangakonto -->
          <div class="mb-3">
            <label for="{{ form.company_bank_account.id }}" class="form-label">
              {{ form.company_bank_account.label.text }}
            </label>
            {{ form.company_bank_account(class_="form-control" + (" is-invalid" if form.company_bank_account.errors else "")) }}
            {% if form.company_bank_account.errors %}
            <div class="invalid-feedback">
              {{ form.company_bank_account.errors[0] }}
            </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Kolmas veerg - Logo Galerii -->
        <div class="col-md-4">
          <div class="mb-3">
            <!-- Logo Üleslaadimine -->
            <div class="d-flex align-items-center justify-content-between mb-3">
              <label class="form-label mb-0">
                <i class="bi bi-images me-2"></i>Logo Üleslaadimine
              </label>
            </div>
            
            <!-- Logo Upload Section -->
            <div class="bp-logo-upload-section" id="logoUploadSection">
              <!-- Simplified Drop Zone -->
              <div class="bp-modern-drop-zone" id="logoDropArea">
                <div class="bp-modern-drop-content">
                  <div class="bp-drop-icon-container">
                    <svg class="bp-modern-drop-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M14.83 8L12 5.17L9.17 8L10.59 9.41L11 9L11 16L13 16L13 9L13.41 9.41L14.83 8Z" fill="currentColor"/>
                      <path d="M5 18V20H19V18H21V20C21 21.1 20.1 22 19 22H5C3.9 22 3 21.1 3 20V18H5Z" fill="currentColor"/>
                      <path d="M12 3L7 8H10V12H14V8H17L12 3Z" fill="currentColor"/>
                    </svg>
                  </div>
                  <div class="bp-drop-text-container">
                    <p class="bp-drop-title mb-1">Lohista failid siia või vali failid</p>
                    <p class="bp-drop-subtitle mb-0">Max 2 MB</p>
                  </div>
                </div>
              </div>
              <input type="file" id="logoFileInput" accept="image/*" multiple hidden />
              
            </div>
            
            <!-- Permanent Logo List -->
            <div class="bp-logo-files-section mt-3" id="logoFilesSection">
              <!-- This will show uploaded logos as a list -->
              <div id="logoFilesList" class="bp-logo-files-list">
                <!-- Permanent logo files will be shown here -->
              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Seadete kaart -->
  <div class="bp-card mb-4">
    <div class="bp-card-header">
      <h2 class="h6 m-0"><i class="bi bi-gear me-2"></i>Seadete kaart</h2>
    </div>
    <div class="bp-card-body">
      <div class="row g-3">
        <!-- Esimene veerg -->
        <div class="col-md-4">
          <!-- Vaikimisi KM määr -->
          <div class="mb-3">
            <div class="d-flex align-items-center gap-2 mb-2">
              <label class="form-label mb-0">
                Vaikimisi KM määr <span class="text-danger">*</span>
              </label>
              <button type="button" class="btn btn-outline-secondary" style="font-size: 14px; background-color: transparent !important; color: #114f68 !important; border: 1px solid #114f68 !important; border-radius: 8px !important; padding: 0.25rem 0.5rem;" onclick="showManageVatRatesModal()">
                <i class="bi bi-gear-fill me-1"></i>Halda
              </button>
            </div>
            <div class="dropdown w-100">
              <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="vatRateSelector" data-bs-toggle="dropdown" aria-expanded="false">
                <span id="vatRateLabel">Vali KM määr...</span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="vatRateSelector" id="vatRateDropdown" style="width: max-content; min-width: 100%;">
                {% for value, label in form.default_vat_rate_id.choices %}
                <li><a class="dropdown-item vat-rate-option{% if form.default_vat_rate_id.data|string == value|string %} active{% endif %}" href="#" data-rate-id="{{ value }}" {% if form.default_vat_rate_id.data|string == value|string %}data-selected="true"{% endif %}>{{ label }}</a></li>
                {% endfor %}
              </ul>
            </div>
            <input type="hidden" name="default_vat_rate_id" id="default_vat_rate_id" value="{{ form.default_vat_rate_id.data or '' }}">
            {% if form.default_vat_rate_id.errors %}
            <div class="invalid-feedback">
              {{ form.default_vat_rate_id.errors[0] }}
            </div>
            {% endif %}
            <div class="form-text">Valitud KM määr kasutatakse vaikimisi uute arvete koostamisel</div>
          </div>
          
          <!-- Vaikimisi PDF template -->
          <div class="mb-3">
            <div class="d-flex align-items-center gap-2 mb-2">
              <label class="form-label mb-0">
                Vaikimisi PDF mall <span class="text-danger">*</span>
              </label>
              <a href="{{ url_for('dashboard.pdf_templates') }}" class="btn btn-outline-secondary" style="font-size: 14px; background-color: transparent !important; color: #114f68 !important; border: 1px solid #114f68 !important; border-radius: 8px !important; padding: 0.25rem 0.5rem;">
                <i class="bi bi-gear-fill me-1"></i>Halda
              </a>
            </div>
            <div class="dropdown w-100">
              <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="pdfTemplateSelector" data-bs-toggle="dropdown" aria-expanded="false">
                <span id="pdfTemplateLabel">{{ form.default_pdf_template.data or 'Vali PDF mall...' }}</span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="pdfTemplateSelector" id="pdfTemplateDropdown" style="width: max-content; min-width: 100%;">
                {% for value, label in form.default_pdf_template.choices %}
                <li><a class="dropdown-item pdf-template-option{% if form.default_pdf_template.data == value %} active{% endif %}" href="#" data-template="{{ value }}" {% if form.default_pdf_template.data == value %}data-selected="true"{% endif %}>{{ label }}</a></li>
                {% endfor %}
              </ul>
            </div>
            <input type="hidden" name="default_pdf_template" id="default_pdf_template" value="{{ form.default_pdf_template.data or '' }}">
            {% if form.default_pdf_template.errors %}
            <div class="invalid-feedback">
              {{ form.default_pdf_template.errors[0] }}
            </div>
            {% endif %}
            <div class="form-text">Valitud mall kasutatakse vaikimisi PDF-ide genereerimisel</div>
          </div>
          
        </div>
        
        <!-- Teine veerg -->
        <div class="col-md-4">
          <!-- Vaikimisi maksetingimus -->
          <div class="mb-3">
            <div class="d-flex align-items-center gap-2 mb-2">
              <label class="form-label mb-0">
                Vaikimisi maksetingimus <span class="text-danger">*</span>
              </label>
              <button type="button" class="btn btn-outline-secondary" style="font-size: 14px; background-color: transparent !important; color: #114f68 !important; border: 1px solid #114f68 !important; border-radius: 8px !important; padding: 0.25rem 0.5rem;" onclick="showManagePaymentTermsModal()">
                <i class="bi bi-gear-fill me-1"></i>Halda
              </button>
            </div>
            <div class="dropdown w-100">
              <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="paymentTermsSelector" data-bs-toggle="dropdown" aria-expanded="false">
                <span id="paymentTermsLabel">Vali maksetingimus...</span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="paymentTermsSelector" id="paymentTermsDropdown" style="width: max-content; min-width: 100%;">
                {% for value, label in form.default_payment_terms_id.choices %}
                <li><a class="dropdown-item payment-terms-option{% if form.default_payment_terms_id.data|string == value|string %} active{% endif %}" href="#" data-terms-id="{{ value }}" {% if form.default_payment_terms_id.data|string == value|string %}data-selected="true"{% endif %}>{{ label }}</a></li>
                {% endfor %}
              </ul>
            </div>
            <input type="hidden" name="default_payment_terms_id" id="default_payment_terms_id" value="{{ form.default_payment_terms_id.data or '' }}">
            {% if form.default_payment_terms_id.errors %}
            <div class="invalid-feedback">
              {{ form.default_payment_terms_id.errors[0] }}
            </div>
            {% endif %}
            <div class="form-text">Valitud maksetingimus kasutatakse vaikimisi uute arvete koostamisel</div>
          </div>
          
          <!-- Vaikimisi viivis -->
          <div class="mb-3">
            <div class="d-flex align-items-center gap-2 mb-2">
              <label class="form-label mb-0">
                Vaikimisi viivis <span class="text-danger">*</span>
              </label>
              <button type="button" class="btn btn-outline-secondary" style="font-size: 14px; background-color: transparent !important; color: #114f68 !important; border: 1px solid #114f68 !important; border-radius: 8px !important; padding: 0.25rem 0.5rem;" onclick="showManagePenaltyRatesModal()">
                <i class="bi bi-gear-fill me-1"></i>Halda
              </button>
            </div>
            <div class="dropdown w-100">
              <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="penaltyRateSelector" data-bs-toggle="dropdown" aria-expanded="false">
                <span id="penaltyRateLabel">Vali viivis...</span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="penaltyRateSelector" id="penaltyRateDropdown" style="width: max-content; min-width: 100%;">
                {% for value, label in form.default_penalty_rate_id.choices %}
                <li><a class="dropdown-item penalty-rate-option{% if form.default_penalty_rate_id.data|string == value|string %} active{% endif %}" href="#" data-rate-id="{{ value }}" {% if form.default_penalty_rate_id.data|string == value|string %}data-selected="true"{% endif %}>{{ label }}</a></li>
                {% endfor %}
              </ul>
            </div>
            <input type="hidden" name="default_penalty_rate_id" id="default_penalty_rate_id" value="{{ form.default_penalty_rate_id.data or '' }}">
            {% if form.default_penalty_rate_id.errors %}
            <div class="invalid-feedback">
              {{ form.default_penalty_rate_id.errors[0] }}
            </div>
            {% endif %}
            <div class="form-text">Valitud viivis kasutatakse vaikimisi arvete tähtaja ületamisel</div>
          </div>
          
          <!-- Vaikimisi märkuse silt -->
          <div class="mb-3">
            <div class="d-flex align-items-center gap-2 mb-2">
              <label class="form-label mb-0">
                Arve märkuste silt <span class="text-danger">*</span>
              </label>
              <button type="button" class="btn btn-outline-secondary" style="font-size: 14px; background-color: transparent !important; color: #114f68 !important; border: 1px solid #114f68 !important; border-radius: 8px !important; padding: 0.25rem 0.5rem;" onclick="showManageNoteLabelsModal()">
                <i class="bi bi-gear-fill me-1"></i>Halda
              </button>
            </div>
            <div class="dropdown w-100">
              <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="noteLabelSelector" data-bs-toggle="dropdown" aria-expanded="false">
                <span id="noteLabelLabel">Vali märkuse silt...</span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="noteLabelSelector" id="noteLabelDropdown" style="width: max-content; min-width: 100%;">
                {% for value, label in note_label_choices %}
                <li><a class="dropdown-item note-label-option{% if default_note_label_id|string == value|string %} active{% endif %}" href="#" data-label-id="{{ value }}" {% if default_note_label_id|string == value|string %}data-selected="true"{% endif %}>{{ label }}</a></li>
                {% endfor %}
              </ul>
            </div>
            <input type="hidden" name="default_note_label_id" id="default_note_label_id" value="{{ default_note_label_id or '' }}">
            <div class="form-text">Valitud silt kuvatakse arvetes märkuste välja asemel (nt "Viitenumber", "Projektinumber")</div>
          </div>
        </div>
        
        <!-- Kolmas veerg - Turundussõnumid -->
        <div class="col-md-4">
          <div class="mb-3">
            <label for="{{ form.marketing_messages.id }}" class="form-label">
              {{ form.marketing_messages.label.text }}
            </label>
            {{ form.marketing_messages(class_="form-control" + (" is-invalid" if form.marketing_messages.errors else ""), rows="8", placeholder="Turundussõnumid ja teadaanded...") }}
            {% if form.marketing_messages.errors %}
            <div class="invalid-feedback">
              {{ form.marketing_messages.errors[0] }}
            </div>
            {% endif %}
          </div>
        </div>

        
      </div>
    </div>
  </div>

  <!-- Arve andmete dokumentatsioon -->
  <div class="bp-card mb-4">
    <div class="bp-card-header">
      <h2 class="h6 m-0"><i class="bi bi-file-text me-2"></i>Arve andmete dokumentatsioon</h2>
    </div>
    <div class="bp-card-body">
      <p class="text-muted mb-4">PDF mallide koostamiseks kasutatavad muutujad (kopeeri ja kleebi PDF template'itesse):</p>
      
      <div class="row">
        <div class="col-md-4">
          <h6>Ettevõtte andmed:</h6>
          <ul class="list-unstyled small">
            <li>Ettevõtte nimi: <code>&#123;&#123; company.company_name &#125;&#125;</code></li>
            <li>E-post: <code>&#123;&#123; company.company_email &#125;&#125;</code></li>
            <li>Telefon: <code>&#123;&#123; company.company_phone &#125;&#125;</code></li>
            <li>Aadress: <code>&#123;&#123; company.company_address &#125;&#125;</code></li>
            <li>Registrikood: <code>&#123;&#123; company.company_registry_code &#125;&#125;</code></li>
            <li>KMKR number: <code>&#123;&#123; company.company_vat_number &#125;&#125;</code></li>
            <li>Veebileht: <code>&#123;&#123; company.company_website &#125;&#125;</code></li>
            <li>Template-spetsiifiline logo URL: <code>&#123;&#123; company.get_logo_for_template_new('template_nimi') &#125;&#125;</code></li>
            <li>Pank: <code>&#123;&#123; company.company_bank &#125;&#125;</code></li>
            <li>Pangakonto: <code>&#123;&#123; company.company_bank_account &#125;&#125;</code></li>
            <li>Turundussõnumid: <code>&#123;&#123; company.marketing_messages &#125;&#125;</code></li>
            <li>Viivis nimi: <code>&#123;&#123; company.default_penalty_rate_obj.name &#125;&#125;</code></li>
            <li>Viivise määr päevas: <code>&#123;&#123; company.default_penalty_rate_obj.rate_per_day &#125;&#125;</code></li>
          </ul>
        </div>
        <div class="col-md-4">
          <h6>Arve andmed:</h6>
          <ul class="list-unstyled small">
            <li>Arve number: <code>&#123;&#123; invoice.number &#125;&#125;</code></li>
            <li>Arve kuupäev: <code>&#123;&#123; invoice.date &#125;&#125;</code></li>
            <li>Maksetähtaeg: <code>&#123;&#123; invoice.due_date &#125;&#125;</code></li>
            <li>Vahesumma: <code>&#123;&#123; invoice.subtotal &#125;&#125;</code></li>
            <li>Kogusumma: <code>&#123;&#123; invoice.total &#125;&#125;</code></li>
            <li>KM summa: <code>&#123;&#123; invoice.vat_amount &#125;&#125;</code></li>
            <li>KM määr: <code>&#123;&#123; invoice.vat_rate &#125;&#125;</code></li>
            <li>Staatus: <code>&#123;&#123; invoice.status &#125;&#125;</code></li>
            <li>Märkus: <code>&#123;&#123; invoice.note &#125;&#125;</code></li>
            <li>Info ja Teadaanded: <code>&#123;&#123; invoice.announcements &#125;&#125;</code></li>
            <li>Maksetingimus: <code>&#123;&#123; invoice.payment_terms &#125;&#125;</code></li>
          </ul>
          <h6 class="mt-3">Arve read:</h6>
          <ul class="list-unstyled small">
            <li><code>&#123;% for line in invoice.lines %&#125;</code></li>
            <li>Kirjeldus: <code>&#123;&#123; line.description &#125;&#125;</code></li>
            <li>Kogus: <code>&#123;&#123; line.qty &#125;&#125;</code></li>
            <li>Ühiku hind: <code>&#123;&#123; line.unit_price &#125;&#125;</code></li>
            <li>Rea summa: <code>&#123;&#123; line.line_total &#125;&#125;</code></li>
            <li><code>&#123;% endfor %&#125;</code></li>
          </ul>
        </div>
        <div class="col-md-4">
          <h6>Kliendi andmed:</h6>
          <ul class="list-unstyled small">
            <li>Kliendi nimi: <code>&#123;&#123; invoice.client.name &#125;&#125;</code></li>
            <li>E-post: <code>&#123;&#123; invoice.client.email &#125;&#125;</code></li>
            <li>Telefon: <code>&#123;&#123; invoice.client.phone &#125;&#125;</code></li>
            <li>Aadress: <code>&#123;&#123; invoice.client.address &#125;&#125;</code></li>
            <li>Registrikood: <code>&#123;&#123; invoice.client.registry_code &#125;&#125;</code></li>
            <li>Kliendi lisainfo: <code>&#123;&#123; invoice.client_extra_info &#125;&#125;</code></li>
          </ul>
          <h6 class="mt-3">Lisaandmed:</h6>
          <ul class="list-unstyled small">
            <li>Märkuse liik: <code>&#123;&#123; note_label &#125;&#125;</code></li>
            <li>Logo absoluutne URL (PDF): <code>&#123;&#123; template_logo_absolute &#125;&#125;</code></li>
          </ul>
        </div>
      </div>
    </div>
  </div>


  <!-- KM määrade haldamise modal -->
  <div class="modal fade" id="manageVatRatesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 25%; width: 25%;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">KM määrade haldamine</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulge"></button>
        </div>
        <div class="modal-body">
          <!-- Add new VAT rate section -->
          <div class="d-flex align-items-center gap-1 mb-2 bp-management-add-section">
            <div class="flex-shrink-0">
              <i class="bi bi-plus-lg"></i>
            </div>
            <div class="flex-grow-1">
              <input type="number" class="form-control" id="newVatRateInput" placeholder="Sisesta KM määr (nt. 24)" min="0" max="100" step="0.01">
            </div>
            <div class="flex-shrink-0">
              <button type="button" class="btn btn-primary" style="font-size: 12px; padding: 0.25rem 0.5rem;" onclick="addNewVatRate()">
                <i class="bi bi-check-lg me-1"></i>Lisa
              </button>
            </div>
          </div>
          
          <!-- Existing VAT rates list -->
          <div id="vatRatesManagementList">
            <!-- Populated by JavaScript -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sulge</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Maksetingimuste haldamise modal -->
  <div class="modal fade" id="managePaymentTermsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 25%; width: 25%;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Maksetingimuste haldamine</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulge"></button>
        </div>
        <div class="modal-body">
          <!-- Add new payment term section -->
          <div class="d-flex align-items-center gap-1 mb-2 bp-management-add-section">
            <div class="flex-shrink-0">
              <i class="bi bi-plus-lg"></i>
            </div>
            <div class="flex-grow-1">
              <input type="number" class="form-control" id="newPaymentTermInput" placeholder="Sisesta päevade arv (nt. 30)" min="0" max="365">
            </div>
            <div class="flex-shrink-0">
              <button type="button" class="btn btn-primary" style="font-size: 12px; padding: 0.25rem 0.5rem;" onclick="addNewPaymentTerm()">
                <i class="bi bi-check-lg me-1"></i>Lisa
              </button>
            </div>
          </div>
          
          <!-- Existing payment terms list -->
          <div id="paymentTermsManagementList">
            <!-- Populated by JavaScript -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sulge</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Märkuste siltide haldamise modal -->
  <div class="modal fade" id="manageNoteLabelsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 25%; width: 25%;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Märkuste siltide haldamine</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulge"></button>
        </div>
        <div class="modal-body">
          <!-- Add new note label section -->
          <div class="d-flex align-items-center gap-1 mb-2 bp-management-add-section">
            <div class="flex-shrink-0">
              <i class="bi bi-plus-lg"></i>
            </div>
            <div class="flex-grow-1">
              <input type="text" class="form-control" id="newNoteLabelInput" placeholder="Sisesta märkuse silt (nt. Viitenumber)" maxlength="50">
            </div>
            <div class="flex-shrink-0">
              <button type="button" class="btn btn-primary" style="font-size: 12px; padding: 0.25rem 0.5rem;" onclick="addNewNoteLabel()">
                <i class="bi bi-check-lg me-1"></i>Lisa
              </button>
            </div>
          </div>
          
          <!-- Existing note labels list -->
          <div id="noteLabelsManagementList">
            <!-- Populated by JavaScript -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sulge</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Viiviste haldamise modal -->
  <div class="modal fade" id="managePenaltyRatesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 25%; width: 25%;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Viiviste haldamine</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulge"></button>
        </div>
        <div class="modal-body">
          <!-- Add new penalty rate section -->
          <div class="d-flex align-items-center gap-1 mb-2 bp-management-add-section">
            <div class="flex-shrink-0">
              <i class="bi bi-plus-lg"></i>
            </div>
            <div class="flex-grow-1">
              <input type="number" class="form-control" id="newPenaltyRateInput" placeholder="Sisesta viivise määr (nt. 0.5)" min="0" max="10" step="0.1">
            </div>
            <div class="flex-shrink-0">
              <button type="button" class="btn btn-primary" style="font-size: 12px; padding: 0.25rem 0.5rem;" onclick="addNewPenaltyRate()">
                <i class="bi bi-check-lg me-1"></i>Lisa
              </button>
            </div>
          </div>
          
          <!-- Existing penalty rates list -->
          <div id="penaltyRatesManagementList">
            <!-- Populated by JavaScript -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sulge</button>
        </div>
      </div>
    </div>
  </div>
  
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing logo upload...');
  
  // Debug: Check if elements exist
  const uploadSection = document.getElementById('logoUploadSection');
  const dropArea = document.getElementById('logoDropArea');
  const fileInput = document.getElementById('logoFileInput');
  
  console.log('Upload section element:', uploadSection);
  console.log('Drop area element:', dropArea);
  console.log('File input element:', fileInput);
  
  if (uploadSection) {
    console.log('Upload section computed style:', window.getComputedStyle(uploadSection).display);
    console.log('Upload section visibility:', window.getComputedStyle(uploadSection).visibility);
    console.log('Upload section opacity:', window.getComputedStyle(uploadSection).opacity);
  }
  
  // Initialize logo system with small delay
  setTimeout(() => {
    initLogoSystem();
  }, 100);
  
  
  // Systematic hover effect system - works for all blue buttons including dynamic ones
  window.applyHoverEffect = function(element) {
    if (element.dataset.hoverApplied) return; // Avoid duplicate listeners
    
    console.log('Applying hover effect to:', element);
    element.dataset.hoverApplied = 'true';
    
    element.addEventListener('mouseenter', function() {
      this.style.setProperty('background-color', '#114f68', 'important');
      this.style.setProperty('color', '#ffffff', 'important');
      this.style.setProperty('border-color', '#114f68', 'important');
      this.style.setProperty('transform', 'translateY(-1px)', 'important');
      this.style.setProperty('box-shadow', '0 2px 4px rgba(8, 145, 178, 0.3)', 'important');
    });
    
    element.addEventListener('mouseleave', function() {
      this.style.setProperty('background-color', 'transparent', 'important');
      this.style.setProperty('color', '#114f68', 'important');
      this.style.setProperty('border-color', '#114f68', 'important');
      this.style.setProperty('transform', 'translateY(0)', 'important');
      this.style.setProperty('box-shadow', 'none', 'important');
    });
  }
  
  // Function to find and apply effects to all blue buttons
  function applyHoverToAllBlueButtons() {
    const allBlueButtons = document.querySelectorAll('button[style*="color: #114f68"], a[style*="color: #114f68"], .btn[style*="color: #114f68"]');
    console.log('Found blue buttons:', allBlueButtons.length);
    
    allBlueButtons.forEach(button => {
      window.applyHoverEffect(button);
    });
  }
  
  // Initial application
  applyHoverToAllBlueButtons();
  
  // Observer for dynamic content
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      mutation.addedNodes.forEach(function(node) {
        if (node.nodeType === 1) { // Element node
          // Check the node itself
          if (node.style && node.style.color && node.style.color.includes('#114f68')) {
            window.applyHoverEffect(node);
          }
          // Check descendants
          const childButtons = node.querySelectorAll ? node.querySelectorAll('button[style*="color: #114f68"], a[style*="color: #114f68"], .btn[style*="color: #114f68"]') : [];
          childButtons.forEach(button => {
            window.applyHoverEffect(button);
          });
        }
      });
    });
  });
  
  // Start observing
  observer.observe(document.body, { childList: true, subtree: true });
  
  // PDF Template Dropdown Functionality
  const pdfTemplateOptions = document.querySelectorAll('.pdf-template-option');
  const pdfTemplateLabel = document.getElementById('pdfTemplateLabel');
  const pdfTemplateInput = document.getElementById('default_pdf_template');
  
  pdfTemplateOptions.forEach(option => {
      // Set initial selected state
      if (option.dataset.selected === 'true') {
          pdfTemplateLabel.textContent = option.textContent;
          pdfTemplateInput.value = option.dataset.template;
      }
      
      option.addEventListener('click', function(e) {
          e.preventDefault();
          const template = this.dataset.template;
          const label = this.textContent;
          
          // Update UI
          pdfTemplateLabel.textContent = label;
          pdfTemplateInput.value = template;
          
          // Remove active state from all options
          pdfTemplateOptions.forEach(opt => opt.classList.remove('active'));
          // Add active state to selected option
          this.classList.add('active');
          
          // Close dropdown
          const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('pdfTemplateSelector'));
          if (dropdown) dropdown.hide();
      });
  });
  
  // VAT Rate Dropdown Functionality
  const vatRateOptions = document.querySelectorAll('.vat-rate-option');
  const vatRateLabel = document.getElementById('vatRateLabel');
  const vatRateInput = document.getElementById('default_vat_rate_id');
  
  vatRateOptions.forEach(option => {
      // Set initial selected state
      if (option.dataset.selected === 'true') {
          vatRateLabel.textContent = option.textContent;
          vatRateInput.value = option.dataset.rateId;
      }
      
      option.addEventListener('click', function(e) {
          e.preventDefault();
          const rateId = this.dataset.rateId;
          const label = this.textContent;
          
          // Update UI
          vatRateLabel.textContent = label;
          vatRateInput.value = rateId;
          
          // Remove active state from all options
          vatRateOptions.forEach(opt => opt.classList.remove('active'));
          // Add active state to selected option
          this.classList.add('active');
          
          // Close dropdown
          const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('vatRateSelector'));
          if (dropdown) dropdown.hide();
      });
  });
  
  // Payment Terms Dropdown Functionality
  const paymentTermsOptions = document.querySelectorAll('.payment-terms-option');
  const paymentTermsLabel = document.getElementById('paymentTermsLabel');
  const paymentTermsInput = document.getElementById('default_payment_terms_id');
  
  paymentTermsOptions.forEach(option => {
      // Set initial selected state
      if (option.dataset.selected === 'true') {
          paymentTermsLabel.textContent = option.textContent;
          paymentTermsInput.value = option.dataset.termsId;
      }
      
      option.addEventListener('click', function(e) {
          e.preventDefault();
          const termsId = this.dataset.termsId;
          const label = this.textContent;
          
          // Update UI
          paymentTermsLabel.textContent = label;
          paymentTermsInput.value = termsId;
          
          // Remove active state from all options
          paymentTermsOptions.forEach(opt => opt.classList.remove('active'));
          // Add active state to selected option
          this.classList.add('active');
          
          // Close dropdown
          const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('paymentTermsSelector'));
          if (dropdown) dropdown.hide();
      });
  });
  
  // Penalty Rate Dropdown Functionality
  const penaltyRateOptions = document.querySelectorAll('.penalty-rate-option');
  const penaltyRateLabel = document.getElementById('penaltyRateLabel');
  const penaltyRateInput = document.getElementById('default_penalty_rate_id');
  
  penaltyRateOptions.forEach(option => {
      // Set initial selected state
      if (option.dataset.selected === 'true') {
          penaltyRateLabel.textContent = option.textContent;
          penaltyRateInput.value = option.dataset.rateId;
      }
      
      option.addEventListener('click', function(e) {
          e.preventDefault();
          const rateId = this.dataset.rateId;
          const label = this.textContent;
          
          // Update UI
          penaltyRateLabel.textContent = label;
          penaltyRateInput.value = rateId;
          
          // Remove active state from all options
          penaltyRateOptions.forEach(opt => opt.classList.remove('active'));
          // Add active state to selected option
          this.classList.add('active');
          
          // Close dropdown
          const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('penaltyRateSelector'));
          if (dropdown) dropdown.hide();
      });
  });
  
  // Note Label dropdown event listeners
  const noteLabelOptions = document.querySelectorAll('.note-label-option');
  const noteLabelLabel = document.getElementById('noteLabelLabel');
  const noteLabelInput = document.getElementById('default_note_label_id');
  
  noteLabelOptions.forEach(option => {
      // Set initial selected state
      if (option.dataset.selected === 'true') {
          noteLabelLabel.textContent = option.textContent;
          noteLabelInput.value = option.dataset.labelId;
      }
      
      option.addEventListener('click', function(e) {
          e.preventDefault();
          const labelId = this.dataset.labelId;
          const label = this.textContent;
          
          // Update UI
          noteLabelLabel.textContent = label;
          noteLabelInput.value = labelId;
          
          // Remove active state from all options
          noteLabelOptions.forEach(opt => opt.classList.remove('active'));
          // Add active state to selected option
          this.classList.add('active');
          
          // Close dropdown
          const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('noteLabelSelector'));
          if (dropdown) dropdown.hide();
      });
  });
  
  
  // Add Enter key support for management inputs
  document.getElementById('newVatRateInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      addNewVatRate();
    }
  });
  
  document.getElementById('newPaymentTermInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      addNewPaymentTerm();
    }
  });
  
  document.getElementById('newPenaltyRateInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      addNewPenaltyRate();
    }
  });
  
  document.getElementById('newNoteLabelInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      addNewNoteLabel();
    }
  });
});

// Modern numerical-only approach - no separate add modals needed

function showManageVatRatesModal() {
  // Load VAT rates list
  fetch('/settings/vat-rates-list')
  .then(response => response.json())
  .then(data => {
    const listContainer = document.getElementById('vatRatesManagementList');
    
    if (data.vat_rates && data.vat_rates.length > 0) {
      let html = '';
      data.vat_rates.forEach(rate => {
        html += `
          <div class="bp-management-item d-flex align-items-center justify-content-between mb-1">
            <div class="d-flex align-items-center gap-3">
              <span class="badge bg-primary fs-6 px-3 py-2">${rate.rate}%</span>
              ${!rate.is_active ? '<span class="badge bg-secondary">Mitteaktiivne</span>' : ''}
            </div>
            <button class="bp-management-remove-btn" onclick="deleteVatRate(${rate.id}, ${rate.rate})" title="Eemalda KM määr"></button>
          </div>
        `;
      });
      listContainer.innerHTML = html;
    } else {
      listContainer.innerHTML = '<div class="text-center text-muted py-3">KM määrad puuduvad</div>';
    }
    
    // Clear the input field
    document.getElementById('newVatRateInput').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('manageVatRatesModal'));
    modal.show();
  })
  .catch(error => {
    console.error('Error loading VAT rates:', error);
    BilliPocket.showMessage('Viga KM määrade laadimisel', 'error');
  });
}

function showManagePaymentTermsModal() {
  // Load payment terms list
  fetch('/settings/payment-terms-list')
  .then(response => response.json())
  .then(data => {
    const listContainer = document.getElementById('paymentTermsManagementList');
    
    if (data.payment_terms && data.payment_terms.length > 0) {
      let html = '';
      data.payment_terms.forEach(term => {
        html += `
          <div class="bp-management-item d-flex align-items-center justify-content-between mb-1">
            <div class="d-flex align-items-center gap-3">
              <span class="badge bg-success fs-6 px-3 py-2">${term.days} ${term.days === 1 ? 'päev' : 'päeva'}</span>
              ${!term.is_active ? '<span class="badge bg-secondary">Mitteaktiivne</span>' : ''}
            </div>
            <button class="bp-management-remove-btn" onclick="deletePaymentTerm(${term.id}, ${term.days})" title="Eemalda maksetingimus"></button>
          </div>
        `;
      });
      listContainer.innerHTML = html;
    } else {
      listContainer.innerHTML = '<div class="text-center text-muted py-3">Maksetingimused puuduvad</div>';
    }
    
    // Clear the input field
    document.getElementById('newPaymentTermInput').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('managePaymentTermsModal'));
    modal.show();
  })
  .catch(error => {
    console.error('Error loading payment terms:', error);
    BilliPocket.showMessage('Viga maksetingimuste laadimisel', 'error');
  });
}

function addNewVatRate() {
  const rateInput = document.getElementById('newVatRateInput');
  const rate = parseFloat(rateInput.value);
  
  if (isNaN(rate) || rate < 0 || rate > 100) {
    BilliPocket.showMessage('Sisesta korrektne KM määr (0-100%)', 'error');
    rateInput.focus();
    return;
  }
  
  // Auto-generate name based on rate
  const name = `${rate}%`;
  
  fetch('/settings/vat-rates/new', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
    },
    body: JSON.stringify({
      name: name,
      rate: rate,
      description: '',
      is_active: true
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      BilliPocket.showMessage('KM määr lisatud', 'success');
      
      // Add new option to main page dropdown
      const dropdown = document.getElementById('vatRateDropdown');
      if (dropdown) {
        const newListItem = document.createElement('li');
        newListItem.innerHTML = `<a class="dropdown-item vat-rate-option" href="#" data-rate-id="${data.vat_rate_id}" data-selected="false">${rate}%</a>`;
        dropdown.appendChild(newListItem);
        
        // Add click event to new option
        const newOption = newListItem.querySelector('.vat-rate-option');
        newOption.addEventListener('click', function(e) {
          e.preventDefault();
          const rateId = this.getAttribute('data-rate-id');
          const label = this.textContent;
          
          document.getElementById('vatRateLabel').textContent = label;
          document.getElementById('default_vat_rate_id').value = rateId;
          
          document.querySelectorAll('.vat-rate-option').forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');
          
          const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('vatRateSelector'));
          if (dropdown) dropdown.hide();
        });
      }
      
      // Clear input and refresh modal list
      rateInput.value = '';
      
      // Close current modal and reopen refreshed one
      const currentModal = bootstrap.Modal.getInstance(document.getElementById('manageVatRatesModal'));
      if (currentModal) {
        currentModal.hide();
      }
      
      // Small delay to ensure modal is fully closed before reopening
      setTimeout(() => {
        // Clean up any remaining backdrop
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        showManageVatRatesModal();
      }, 300);
    } else {
      BilliPocket.showMessage(data.message || 'Viga KM määra lisamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    BilliPocket.showMessage('Viga KM määra lisamisel', 'error');
  });
}

function addNewPaymentTerm() {
  const daysInput = document.getElementById('newPaymentTermInput');
  const days = parseInt(daysInput.value);
  
  if (isNaN(days) || days < 0 || days > 365) {
    BilliPocket.showMessage('Sisesta korrektne päevade arv (0-365)', 'error');
    daysInput.focus();
    return;
  }
  
  // Auto-generate name based on days
  const name = `${days} ${days === 1 ? 'päev' : 'päeva'}`;
  
  fetch('/settings/payment-terms', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
    },
    body: JSON.stringify({
      name: name,
      days: days,
      is_default: false,
      is_active: true
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      BilliPocket.showMessage('Maksetingimus lisatud', 'success');
      
      // Add new option to main page dropdown
      const dropdown = document.getElementById('paymentTermsDropdown');
      if (dropdown) {
        const newListItem = document.createElement('li');
        newListItem.innerHTML = `<a class="dropdown-item payment-terms-option" href="#" data-terms-id="${data.payment_term_id}" data-selected="false">${name}</a>`;
        dropdown.appendChild(newListItem);
        
        // Add click event to new option
        const newOption = newListItem.querySelector('.payment-terms-option');
        newOption.addEventListener('click', function(e) {
          e.preventDefault();
          const termsId = this.getAttribute('data-terms-id');
          const label = this.textContent;
          
          document.getElementById('paymentTermsLabel').textContent = label;
          document.getElementById('default_payment_terms_id').value = termsId;
          
          document.querySelectorAll('.payment-terms-option').forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');
          
          const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('paymentTermsSelector'));
          if (dropdown) dropdown.hide();
        });
      }
      
      // Clear input and refresh modal list
      daysInput.value = '';
      
      // Close current modal and reopen refreshed one
      const currentModal = bootstrap.Modal.getInstance(document.getElementById('managePaymentTermsModal'));
      if (currentModal) {
        currentModal.hide();
      }
      
      // Small delay to ensure modal is fully closed before reopening
      setTimeout(() => {
        // Clean up any remaining backdrop
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        showManagePaymentTermsModal();
      }, 300);
    } else {
      BilliPocket.showMessage(data.message || 'Viga maksetingimuse lisamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    BilliPocket.showMessage('Viga maksetingimuse lisamisel', 'error');
  });
}

// VAT Rate management functions - only add and delete needed

function deleteVatRate(id, rate) {
  // Directly delete without confirmation dialog
  
  fetch(`/settings/vat-rates/${id}/delete`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      BilliPocket.showMessage('KM määr kustutatud', 'success');
      // Refresh the management modal
      showManageVatRatesModal();
      // Refresh the dropdown by reloading the page
      setTimeout(() => location.reload(), 1000);
    } else {
      BilliPocket.showMessage(data.message || 'Viga KM määra kustutamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    BilliPocket.showMessage('Viga KM määra kustutamisel', 'error');
  });
}

// Payment term management functions - only add and delete needed

function deletePaymentTerm(id, days) {
  // Directly delete without confirmation dialog
  
  fetch(`/settings/payment-terms/${id}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      BilliPocket.showMessage('Maksetingimus kustutatud', 'success');
      // Refresh the management modal
      showManagePaymentTermsModal();
      // Refresh the dropdown by reloading the page
      setTimeout(() => location.reload(), 1000);
    } else {
      BilliPocket.showMessage(data.message || 'Viga maksetingimuse kustutamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    BilliPocket.showMessage('Viga maksetingimuse kustutamisel', 'error');
  });
}

// Removed old duplicate logo upload functions - replaced by new centralized system

// =============================================================================
// LOGO GALLERY SYSTEM - New Centralized Logo Management
// =============================================================================

let logoGalleryData = [];
let isUploadSectionVisible = false;

function initLogoSystem() {
  console.log('Initializing logo system...');
  
  // Ensure DOM elements exist before initializing
  const filesListElement = document.getElementById('logoFilesList');
  if (!filesListElement) {
    console.warn('Logo files list element not found, retrying in 100ms...');
    setTimeout(initLogoSystem, 100);
    return;
  }
  
  // Initialize drag & drop
  initLogoDragDrop();
  
  // Load logos from server with small delay to ensure DOM is ready
  setTimeout(() => {
    loadLogosFromServer();
  }, 50);
}









function loadLogosFromServer() {
  console.log('Loading logos from server...');
  const logoFilesList = document.getElementById('logoFilesList');
  
  if (!logoFilesList) {
    console.error('Logo files list element not found');
    return;
  }
  
  fetch('/settings/logos', {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    console.log('Logos API response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Loaded logos:', data);
    logoGalleryData = data.logos || [];
    renderLogoList();
  })
  .catch(error => {
    console.error('Error loading logos:', error);
    
    // Show error message in the files list area
    logoFilesList.innerHTML = `
      <div class="text-center py-4 text-muted">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Logode laadimine ebaõnnestus
      </div>
    `;
  });
}

function renderLogoList() {
  console.log('Rendering logo list, data length:', logoGalleryData.length);
  const logoFilesList = document.getElementById('logoFilesList');
  
  if (!logoFilesList) {
    console.error('Logo files list element not found');
    return;
  }
  
  if (logoGalleryData.length === 0) {
    console.log('No logos to show');
    logoFilesList.innerHTML = '';
    return;
  }
  
  console.log('Showing logo files list');
  
  // Generate HTML for logo file items
  let html = '';
  logoGalleryData.forEach(logo => {
    const uploadDate = new Date(logo.upload_date).toLocaleDateString('et-EE');
    const fileSize = (logo.file_size_mb ? (logo.file_size_mb * 1024).toFixed(0) + ' KB' : (((logo.file_size || 0) / 1024).toFixed(0) + ' KB'));
    
    html += `
      <div class="logo-item" data-logo-id="${logo.id}" onclick="selectLogo(${logo.id})" 
           style="display: flex; align-items: center; background: #fff; border: 1px solid #e9ecef; border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.3rem; cursor: pointer; min-height: 60px;">
        <img src="${logo.url}" alt="${logo.original_name}" 
             style="width: 48px; height: 48px; object-fit: contain; border-radius: 6px; background: #f8f9fa; margin-right: 0.75rem; flex-shrink: 0;"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div style="display: none; width: 48px; height: 48px; background: #f8f9fa; border-radius: 6px; margin-right: 0.75rem; flex-shrink: 0; align-items: center; justify-content: center;">
          <i class="bi bi-file-earmark-image" style="color: #6c757d;"></i>
        </div>
        <div style="flex: 1; min-width: 0;">
          <div style="font-size: 0.875rem; font-weight: 500; color: #212529; margin: 0 0 0.25rem 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${logo.original_name}</div>
          <div style="font-size: 0.75rem; color: #6c757d; margin: 0; display: flex; gap: 1rem;">
            <span style="display: flex; align-items: center; gap: 0.25rem;">
              <i class="bi bi-calendar3"></i>${uploadDate}
            </span>
            <span style="display: flex; align-items: center; gap: 0.25rem;">
              <i class="bi bi-hdd"></i>${fileSize}
            </span>
          </div>
        </div>
        <button type="button" onclick="event.stopPropagation(); deleteLogoFromList(${logo.id})" 
                title="Eemalda logo"
                class="bp-logo-remove-btn-simple">
          ×
        </button>
      </div>
    `;
  });
  
  logoFilesList.innerHTML = html;
  console.log('Logo files list updated, total logos:', logoGalleryData.length);
  
  // No longer needed - using simple text-based remove buttons
}


function deleteLogoFromList(logoId) {
  console.log('Deleting logo from list:', logoId);
  
  const logoData = logoGalleryData.find(logo => logo.id === logoId);
  const logoName = logoData ? logoData.original_name : 'see logo';
  
  // Use custom confirmation modal instead of browser confirm
  showCustomConfirm(
    'Kustuta logo',
    `Kas oled kindel, et soovid kustutada logo "${logoName}"?`,
    function() {
      // Confirmed - proceed with deletion
      executeLogoDelete(logoId);
    }
  );
}

function executeLogoDelete(logoId) {
  // Add CSRF token
  const formData = new FormData();
  const csrfToken = document.querySelector('input[name="csrf_token"]');
  if (csrfToken) {
    formData.append('csrf_token', csrfToken.value);
  }
  
  fetch(`/settings/logos/${logoId}`, {
    method: 'POST',
    headers: {
      'X-HTTP-Method-Override': 'DELETE'
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('Logo deleted successfully');
      BilliPocket.showMessage('Logo edukalt kustutatud', 'success');
      loadLogosFromServer(); // Refresh list
    } else {
      BilliPocket.showMessage(data.message || 'Viga logo kustutamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Error deleting logo:', error);
    BilliPocket.showMessage('Viga logo kustutamisel', 'error');
  });
}

function selectLogo(logoId) {
  const logoData = logoGalleryData.find(logo => logo.id === logoId);
  if (!logoData) return;
  
  // Show preview modal
  showLogoPreviewModal(logoData);
}

function showLogoPreviewModal(logoData) {
  // Remove existing modal if any
  const existingModal = document.getElementById('logoPreviewModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Create preview modal HTML
  const modalHtml = `
    <div class="modal fade" id="logoPreviewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0 pb-2">
            <h5 class="modal-title d-flex align-items-center">
              <i class="bi bi-image text-primary me-2"></i>
              Logo eelvaade
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <!-- Logo Preview -->
            <div class="bp-logo-preview-container mb-4">
              <img src="${logoData.url}" alt="${logoData.original_name}" class="bp-logo-preview-image" />
            </div>
            
            <!-- Logo Info -->
            <div class="bp-logo-info">
              <h6 class="mb-2">${logoData.original_name}</h6>
              <div class="row text-muted small">
                <div class="col-6">
                  <i class="bi bi-calendar3 me-1"></i>
                  Üles laaditud: ${logoData.upload_date}
                </div>
                <div class="col-6">
                  <i class="bi bi-hdd me-1"></i>
                  Suurus: ${logoData.file_size_mb ? (logoData.file_size_mb * 1024).toFixed(0) + ' KB' : ((logoData.file_size / 1024).toFixed(0) + ' KB')}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  const modal = new bootstrap.Modal(document.getElementById('logoPreviewModal'));
  
  // Handle modal cleanup
  document.getElementById('logoPreviewModal').addEventListener('hidden.bs.modal', function() {
    this.remove();
  });
  
  modal.show();
}


function deleteLogoFromPreview(logoId) {
  // Close preview modal first
  const modal = bootstrap.Modal.getInstance(document.getElementById('logoPreviewModal'));
  if (modal) modal.hide();
  
  // Use the existing delete function
  deleteLogoFromGallery(logoId);
}




function initLogoDragDrop() {
  console.log('Initializing logo drag & drop...');
  
  const dropArea = document.getElementById('logoDropArea');
  const fileInput = document.getElementById('logoFileInput');
  
  if (!dropArea) {
    console.error('Drop area not found');
    return;
  }
  
  if (!fileInput) {
    console.error('File input not found');
    return;
  }
  
  console.log('Drop area and file input found, setting up event listeners...');
  
  // Clear any existing event listeners by cloning the elements
  const newDropArea = dropArea.cloneNode(true);
  const newFileInput = fileInput.cloneNode(true);
  
  dropArea.parentNode.replaceChild(newDropArea, dropArea);
  fileInput.parentNode.replaceChild(newFileInput, fileInput);
  
  // Update references to new elements
  const finalDropArea = document.getElementById('logoDropArea');
  const finalFileInput = document.getElementById('logoFileInput');
  
  // Prevent default drag behaviors
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    finalDropArea.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
  });
  
  // Highlight drop area when item is dragged over it
  ['dragenter', 'dragover'].forEach(eventName => {
    finalDropArea.addEventListener(eventName, highlightDropArea, false);
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    finalDropArea.addEventListener(eventName, unhighlightDropArea, false);
  });
  
  // Handle dropped files
  finalDropArea.addEventListener('drop', handleLogoDrop, false);
  
  // Make entire drop area clickable for file selection
  finalDropArea.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('Drop area clicked, triggering file input...');
    finalFileInput.click();
  });
  
  // Handle file input change
  finalFileInput.addEventListener('change', handleLogoFileSelection);
  
  console.log('All event listeners added successfully');
}

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

function highlightDropArea() {
  document.getElementById('logoDropArea').classList.add('dragover');
}

function unhighlightDropArea() {
  document.getElementById('logoDropArea').classList.remove('dragover');
}

function handleLogoDrop(e) {
  const files = e.dataTransfer.files;
  handleLogoFiles(files);
}

function handleLogoFileSelection(e) {
  const files = e.target.files;
  handleLogoFiles(files);
  
  // Reset the input to allow selecting the same file again
  e.target.value = '';
}

function handleLogoFiles(files) {
  if (files.length === 0) return;
  
  console.log('Handling logo files:', files.length);
  
  // Process each file directly without temporary list
  const maxSize = 2 * 1024 * 1024; // 2MB
  const allowedTypes = ['image/png', 'image/jpg', 'image/jpeg', 'image/svg+xml', 'image/gif'];
  
  Array.from(files).forEach((file, index) => {
    console.log(`Processing file ${index + 1}:`, file.name, file.type, file.size);
    
    // Validate file
    let isValid = true;
    let errorMessage = '';
    
    if (!allowedTypes.includes(file.type)) {
      isValid = false;
      errorMessage = 'Faili tüüp ei ole toetatud';
      console.log('File type not supported:', file.type);
    } else if (file.size > maxSize) {
      isValid = false;
      errorMessage = 'Faili suurus on liiga suur (max 2MB)';
      console.log('File too large:', file.size);
    }
    
    if (!isValid) {
      alert(`${file.name}: ${errorMessage}`);
      console.log('File validation failed:', errorMessage);
    } else {
      console.log('Starting upload for:', file.name);
      // Upload directly to server
      uploadLogoToServerDirect(file);
    }
  });
}

function createFileItem(file, index) {
  const fileItem = document.createElement('div');
  fileItem.className = 'bp-modern-file-item uploading';
  fileItem.setAttribute('data-file-index', index);
  
  const fileSizeFormatted = (file.size / 1024).toFixed(0) + ' KB';
  
  fileItem.innerHTML = `
    <div class="bp-modern-file-icon">
      <i class="bi bi-file-earmark-image text-muted"></i>
      <div class="bp-modern-progress-overlay">
        <div class="bp-modern-progress-bar">
          <div class="bp-modern-progress-fill"></div>
        </div>
      </div>
    </div>
    <div class="bp-modern-file-info">
      <div class="bp-modern-file-name">${file.name}</div>
      <div class="bp-modern-file-size">${fileSizeFormatted}</div>
    </div>
    <div class="bp-modern-file-actions">
      <button type="button" class="bp-modern-file-remove" onclick="removeFileItem(this)" title="Remove">
        <i class="bi bi-trash3"></i>
      </button>
    </div>
  `;
  
  return fileItem;
}

function updateFileItemStatus(fileItem, status, message = '') {
  // Remove old status classes
  fileItem.classList.remove('uploading', 'error', 'success');
  fileItem.classList.add(status);
  
  const icon = fileItem.querySelector('.bp-modern-file-icon');
  const progressOverlay = fileItem.querySelector('.bp-modern-progress-overlay');
  const sizeElement = fileItem.querySelector('.bp-modern-file-size');
  
  // Update icon and progress based on status
  if (status === 'uploading') {
    icon.innerHTML = `
      <i class="bi bi-file-earmark-image text-primary"></i>
      <div class="bp-modern-progress-overlay active">
        <div class="bp-modern-progress-bar">
          <div class="bp-modern-progress-fill animate"></div>
        </div>
      </div>
    `;
  } else if (status === 'error') {
    icon.innerHTML = `
      <i class="bi bi-file-earmark-image text-danger"></i>
      <div class="bp-modern-error-indicator">
        <i class="bi bi-exclamation-circle-fill text-danger"></i>
      </div>
    `;
    if (message) {
      sizeElement.innerHTML = `<span class="text-danger">${message}</span>`;
    }
  } else if (status === 'success') {
    icon.innerHTML = `
      <i class="bi bi-file-earmark-image text-success"></i>
      <div class="bp-modern-success-indicator">
        <i class="bi bi-check-circle-fill text-success"></i>
      </div>
    `;
  }
}

function removeFileItem(button) {
  const fileItem = button.closest('.bp-modern-file-item');
  if (fileItem) {
    fileItem.remove();
    
    // File handled - permanent list will be refreshed
  }
}

function uploadLogoToServerDirect(file) {
  console.log('Uploading logo directly to server:', file.name);
  
  const formData = new FormData();
  formData.append('logo', file);
  
  // Add CSRF token
  const csrfToken = document.querySelector('input[name="csrf_token"]');
  if (csrfToken) {
    formData.append('csrf_token', csrfToken.value);
  }
  
  fetch('/settings/logos/upload', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('Logo uploaded successfully:', data.logo);
      // Refresh the logo gallery
      loadLogosFromServer();
      // Show success message
      BilliPocket.showMessage(`Logo "${file.name}" edukalt üles laaditud!`, 'success');
    } else {
      console.error('Upload failed:', data.message);
      alert(`Viga logo üleslaadimisel: ${data.message}`);
    }
  })
  .catch(error => {
    console.error('Upload error:', error);
    alert('Viga logo üleslaadimisel. Palun proovi uuesti.');
  });
}

function uploadSingleLogoFile(file, fileItem) {
  console.log('Starting upload for file:', file.name);
  
  const formData = new FormData();
  formData.append('logo', file);
  
  // Add CSRF token
  const csrfToken = document.querySelector('input[name="csrf_token"]');
  if (csrfToken) {
    formData.append('csrf_token', csrfToken.value);
    console.log('CSRF token added');
  } else {
    console.warn('CSRF token not found');
  }
  
  fetch('/settings/logos/upload', {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    console.log('Upload response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Upload response data:', data);
    
    if (data.success) {
      updateFileItemStatus(fileItem, 'success');
      console.log('Logo uploaded successfully:', data.logo);
      
      // Logo uploaded successfully - refresh gallery to show new logo
      setTimeout(() => {
        loadLogosFromServer();
      }, 500);
      
      // Keep successful upload visible for 5 seconds instead of 2
      setTimeout(() => {
        if (fileItem && fileItem.parentNode) {
          fileItem.remove();

          // Upload list no longer used
        }
      }, 5000);
      
    } else {
      console.error('Upload failed:', data.message);
      updateFileItemStatus(fileItem, 'error', data.message || 'Üleslaadimise viga');
    }
  })
  .catch(error => {
    console.error('Upload error:', error);
    updateFileItemStatus(fileItem, 'error', `Viga: ${error.message}`);
  });
}

// Legacy function removed - handled by new centralized system

// Alias for compatibility with other parts of the code
function deleteLogoFromGallery(logoId) {
  deleteLogoFromList(logoId);
}

function renameLogoPrompt(logoId, currentName) {
  const newName = prompt(`Sisesta uus nimi logo jaoks:`, currentName);
  if (!newName || newName === currentName) return;
  
  renameLogo(logoId, newName);
}

function renameLogo(logoId, newName) {
  // Add CSRF token
  const formData = new FormData();
  formData.append('original_name', newName);
  const csrfToken = document.querySelector('input[name="csrf_token"]');
  if (csrfToken) {
    formData.append('csrf_token', csrfToken.value);
  }
  
  fetch(`/settings/logos/${logoId}/rename`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      BilliPocket.showMessage('Logo nimetatud ümber', 'success');
      loadLogosFromServer(); // Refresh gallery
    } else {
      BilliPocket.showMessage(data.message || 'Viga logo ümbernimetamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Rename error:', error);
    BilliPocket.showMessage('Viga logo ümbernimetamisel', 'error');
  });
}

// =============================================================================
// LEGACY LOGO FUNCTIONS - Kept for backward compatibility
// =============================================================================

function removeLogo() {
  BilliPocket.showMessage('Logo preview suletud', 'info');
}

// Penalty Rates Management Functions
function showManagePenaltyRatesModal() {
  // Load penalty rates list
  fetch('/settings/penalty-rates-list')
  .then(response => response.json())
  .then(data => {
    const listContainer = document.getElementById('penaltyRatesManagementList');
    
    if (data.penalty_rates && data.penalty_rates.length > 0) {
      let html = '';
      data.penalty_rates.forEach(rate => {
        html += `
          <div class="bp-management-item d-flex align-items-center justify-content-between mb-1">
            <div class="d-flex align-items-center gap-3">
              <span class="badge bg-warning fs-6 px-3 py-2">${rate.name}</span>
              ${!rate.is_active ? '<span class="badge bg-secondary">Mitteaktiivne</span>' : ''}
            </div>
            <button class="bp-management-remove-btn" onclick="deletePenaltyRate(${rate.id}, '${rate.name}')" title="Eemalda viivis"></button>
          </div>
        `;
      });
      listContainer.innerHTML = html;
    } else {
      listContainer.innerHTML = '<div class="text-center text-muted py-3">Viivised puuduvad</div>';
    }
    
    // Clear the input field
    document.getElementById('newPenaltyRateInput').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('managePenaltyRatesModal'));
    modal.show();
  })
  .catch(error => {
    console.error('Error loading penalty rates:', error);
    BilliPocket.showMessage('Viga viiviste laadimisel', 'error');
  });
}

function addNewPenaltyRate() {
  const rateInput = document.getElementById('newPenaltyRateInput');
  const rate = parseFloat(rateInput.value);
  
  if (isNaN(rate) || rate < 0 || rate > 10) {
    BilliPocket.showMessage('Sisesta korrektne viivise määr (0-10%)', 'error');
    rateInput.focus();
    return;
  }
  
  fetch('/settings/penalty-rates', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
    },
    body: JSON.stringify({
      rate_per_day: rate,
      is_default: false,
      is_active: true
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      BilliPocket.showMessage('Viivis lisatud', 'success');
      
      // Add new option to main page dropdown
      const dropdown = document.getElementById('penaltyRateDropdown');
      if (dropdown) {
        // Generate display name like on backend
        let displayName;
        if (rate === 0) {
          displayName = "0% päevas";
        } else if (rate === Math.floor(rate)) {
          displayName = `${Math.floor(rate)}% päevas`;
        } else {
          // Preserve exact input without rounding - remove trailing zeros
          displayName = `${rate.toString().replace('.', ',')}% päevas`;
        }
        
        const newListItem = document.createElement('li');
        newListItem.innerHTML = `<a class="dropdown-item penalty-rate-option" href="#" data-rate-id="${data.penalty_rate_id}" data-selected="false">${displayName}</a>`;
        dropdown.appendChild(newListItem);
        
        // Add click event to new option
        const newOption = newListItem.querySelector('.penalty-rate-option');
        newOption.addEventListener('click', function(e) {
          e.preventDefault();
          const rateId = this.getAttribute('data-rate-id');
          const label = this.textContent;
          
          document.getElementById('penaltyRateLabel').textContent = label;
          document.getElementById('default_penalty_rate_id').value = rateId;
          
          document.querySelectorAll('.penalty-rate-option').forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');
          
          const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('penaltyRateSelector'));
          if (dropdown) dropdown.hide();
        });
      }
      
      // Clear input and refresh modal list
      rateInput.value = '';
      
      // Close current modal and reopen refreshed one
      const currentModal = bootstrap.Modal.getInstance(document.getElementById('managePenaltyRatesModal'));
      if (currentModal) {
        currentModal.hide();
      }
      
      // Small delay to ensure modal is fully closed before reopening
      setTimeout(() => {
        // Clean up any remaining backdrop
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        showManagePenaltyRatesModal();
      }, 300);
    } else {
      BilliPocket.showMessage(data.message || 'Viga viivise lisamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    BilliPocket.showMessage('Viga viivise lisamisel', 'error');
  });
}

// Penalty rate management functions - only add and delete needed

function deletePenaltyRate(id, name) {
  // Directly delete without confirmation dialog
  
  fetch(`/settings/penalty-rates/${id}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      BilliPocket.showMessage('Viivis kustutatud', 'success');
      // Refresh the management modal
      showManagePenaltyRatesModal();
      // Refresh the dropdown by reloading the page
      setTimeout(() => location.reload(), 1000);
    } else {
      BilliPocket.showMessage(data.message || 'Viga viivise kustutamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    BilliPocket.showMessage('Viga viivise kustutamisel', 'error');
  });
}

// Note Labels Management Functions
function showManageNoteLabelsModal() {
  // Load note labels list
  fetch('/settings/note-labels-list')
  .then(response => response.json())
  .then(data => {
    const listContainer = document.getElementById('noteLabelsManagementList');
    
    if (data.note_labels && data.note_labels.length > 0) {
      let html = '';
      data.note_labels.forEach(label => {
        html += `
          <div class="bp-management-item d-flex align-items-center justify-content-between mb-1">
            <div class="d-flex align-items-center gap-3">
              <span class="badge bg-primary fs-6 px-3 py-2">${label.name}</span>
              ${!label.is_active ? '<span class="badge bg-secondary">Mitteaktiivne</span>' : ''}
            </div>
            <button class="bp-management-remove-btn" onclick="deleteNoteLabel(${label.id}, '${label.name}')" title="Eemalda märkuse silt"></button>
          </div>
        `;
      });
      listContainer.innerHTML = html;
    } else {
      listContainer.innerHTML = '<div class="text-center text-muted py-3">Märkuste sildid puuduvad</div>';
    }
    
    // Clear the input field
    document.getElementById('newNoteLabelInput').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('manageNoteLabelsModal'));
    modal.show();
  })
  .catch(error => {
    console.error('Error loading note labels:', error);
    BilliPocket.showMessage('Viga märkuste siltide laadimisel', 'error');
  });
}

function addNewNoteLabel() {
  const labelInput = document.getElementById('newNoteLabelInput');
  const labelName = labelInput.value.trim();
  
  if (!labelName) {
    BilliPocket.showMessage('Sisesta märkuse sildi nimi', 'error');
    labelInput.focus();
    return;
  }
  
  if (labelName.length > 50) {
    BilliPocket.showMessage('Märkuse sildi nimi peab olema kuni 50 tähemärki', 'error');
    labelInput.focus();
    return;
  }
  
  fetch('/settings/note-labels', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
    },
    body: JSON.stringify({
      name: labelName,
      is_default: false  // Never set as default when adding
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      BilliPocket.showMessage('Märkuse silt lisatud', 'success');
      // Clear input
      labelInput.value = '';
      // Refresh the management modal
      setTimeout(() => {
        showManageNoteLabelsModal();
      }, 300);
      // Refresh the dropdown by reloading the page
      setTimeout(() => location.reload(), 1000);
    } else {
      BilliPocket.showMessage(data.message || 'Viga märkuse sildi lisamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    BilliPocket.showMessage('Viga märkuse sildi lisamisel', 'error');
  });
}

function deleteNoteLabel(id, name) {
  // Directly delete without confirmation dialog
  
  fetch(`/settings/note-labels/${id}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      BilliPocket.showMessage('Märkuse silt kustutatud', 'success');
      // Refresh the management modal
      showManageNoteLabelsModal();
      // Refresh the dropdown by reloading the page
      setTimeout(() => location.reload(), 1000);
    } else {
      BilliPocket.showMessage(data.message || 'Viga märkuse sildi kustutamisel', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    BilliPocket.showMessage('Viga märkuse sildi kustutamisel', 'error');
  });
}

// =============================================================================
// CUSTOM CONFIRMATION MODAL
// =============================================================================

function showCustomConfirm(title, message, onConfirm, onCancel) {
  // Remove existing modal if any
  const existingModal = document.getElementById('customConfirmModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Create modal HTML
  const modalHtml = `
    <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0 pb-2">
            <h5 class="modal-title d-flex align-items-center">
              <i class="bi bi-question-circle text-warning me-2"></i>
              ${title}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pb-2">
            <p class="mb-0">${message}</p>
          </div>
          <div class="modal-footer border-0 pt-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-lg me-1"></i>Tühista
            </button>
            <button type="button" class="btn btn-primary" id="confirmButton" style="background-color: var(--bp-primary-600) !important; border-color: var(--bp-primary-600) !important;">
              <i class="bi bi-check-lg me-1"></i>Kinnita
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  const modal = new bootstrap.Modal(document.getElementById('customConfirmModal'));
  const confirmBtn = document.getElementById('confirmButton');
  
  // Handle confirm
  confirmBtn.addEventListener('click', function() {
    modal.hide();
    if (onConfirm) onConfirm();
  });
  
  // Handle cancel/close
  document.getElementById('customConfirmModal').addEventListener('hidden.bs.modal', function() {
    this.remove();
    if (onCancel) onCancel();
  });
  
  modal.show();
}

// Duplicate function removed - already defined above

</script>

<style>
/* =========================================================================== */
/* MODERN UPLOAD MODAL STYLES */
/* =========================================================================== */

/* Modal styling */
.bp-modern-upload-modal .modal-content {
  border-radius: 16px;
  border: none;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.bp-modern-upload-modal .modal-header {
  padding: 1.5rem 1.5rem 0 1.5rem;
}

.bp-modern-upload-modal .modal-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1a1a1a;
}

/* Logo Upload Section */
.bp-logo-upload-section {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  width: 100%;
  height: auto;
  margin: 0;
  padding: 0;
  border: none !important;
}

.bp-logo-upload-section * {
  box-sizing: border-box;
}

/* Drop Zone - Top Section - Reduced Height */
.bp-modern-drop-zone {
  background: linear-gradient(135deg, #f8f9fb 0%, #e9ecef 100%);
  border-radius: 12px;
  border: 2px dashed #cbd5e0;
  padding: 0.6rem 1rem;
  margin: 0;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.bp-modern-drop-zone:hover {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-color: #2196f3;
  transform: translateY(-2px);
}

.bp-modern-drop-zone.dragover {
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  border-color: #4caf50;
  transform: scale(1.02);
}

/* Drop Zone Content */
.bp-modern-drop-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  min-height: 120px;
}

.bp-drop-icon-container {
  background: transparent;
  border: 2px solid #114f68;
  border-radius: 50%;
  padding: 1.2rem;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.bp-modern-drop-icon {
  width: 32px;
  height: 32px;
  color: #114f68;
  transition: all 0.3s ease;
}

.bp-modern-drop-zone:hover .bp-modern-drop-icon {
  color: #2196f3;
  transform: scale(1.1);
}

.bp-modern-drop-zone:hover .bp-drop-icon-container {
  border-color: #2196f3;
  transform: scale(1.05);
}

.bp-drop-text-container {
  text-align: center;
  margin-top: 0.5rem;
}

.bp-drop-title {
  font-size: 1.1rem;
  font-weight: 500;
  color: #495057;
  margin-bottom: 0.15rem;
}

.bp-drop-subtitle {
  color: #6c757d;
  font-size: 0.9rem;
}

/* Browse Button */
.bp-browse-button {
  background: #114f68;
  color: white;
  border: none;
  padding: 0.4rem 0.8rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
  margin-top: 0.4rem;
  transition: all 0.3s ease;
  cursor: pointer;
}

.bp-browse-button:hover {
  background: #0d3a4d;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(17, 79, 104, 0.3);
}

/* === CLEAN LOGO SECTION STYLES === */

.bp-modern-file-icon i {
  font-size: 1.25rem;
  color: #6c757d;
}

/* File Info Section - Center */
.bp-modern-file-info {
  flex-grow: 1;
  min-width: 0;
}

.bp-modern-file-name {
  font-weight: 600;
  color: #1a1a1a;
  font-size: 0.9rem;
  line-height: 1.3;
  margin-bottom: 0.25rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.bp-modern-file-size {
  color: #6c757d;
  font-size: 0.8rem;
  line-height: 1.2;
}

/* Delete Button - Right */
.bp-modern-file-delete {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #ffffff;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
  margin-left: 1rem;
}

.bp-modern-file-delete:hover {
  background: #fee;
  border-color: #fcc;
  color: #dc3545;
}

.bp-modern-file-delete i {
  font-size: 0.85rem;
  color: #6c757d;
}

.bp-modern-file-delete:hover i {
  color: #dc3545;
}

/* Progress Overlay */
.bp-modern-progress-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.bp-modern-progress-overlay.active {
  opacity: 1;
}

/* Progress Bar */
.bp-modern-progress-bar {
  width: 24px;
  height: 24px;
  border: 2px solid #e9ecef;
  border-top: 2px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Alternative progress bar for bottom of file item */
.bp-modern-progress-fill {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
  border-radius: 0 0 12px 12px;
  transition: width 0.3s ease;
  width: 0;
}

.bp-modern-progress-fill.animate {
  animation: progressFill 2s ease-in-out infinite;
}

@keyframes progressFill {
  0% { width: 0%; }
  50% { width: 70%; }
  100% { width: 100%; }
}

/* Status States */
.bp-modern-file-item.uploading {
  border-color: #007bff;
  background: rgba(0, 123, 255, 0.05);
}

.bp-modern-file-item.uploading .bp-modern-file-icon {
  border-color: #007bff;
  background: rgba(0, 123, 255, 0.1);
}

.bp-modern-file-item.success {
  border-color: #28a745;
  background: rgba(40, 167, 69, 0.05);
}

.bp-modern-file-item.success .bp-modern-file-icon {
  border-color: #28a745;
  background: rgba(40, 167, 69, 0.1);
}

.bp-modern-file-item.error {
  border-color: #dc3545;
  background: rgba(220, 53, 69, 0.05);
}

.bp-modern-file-item.error .bp-modern-file-icon {
  border-color: #dc3545;
  background: rgba(220, 53, 69, 0.1);
}

/* Error Indicator */
.bp-modern-error-indicator {
  position: absolute;
  top: -2px;
  right: -2px;
  width: 16px;
  height: 16px;
  background: #dc3545;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #ffffff;
}

.bp-modern-error-indicator i {
  font-size: 0.6rem;
  color: #ffffff;
}

/* Logo Files List Section */
.bp-logo-files-section {
  margin-top: 0.5rem;
  margin-bottom: 0.5rem;
}

.bp-logo-files-list {
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

/* Individual Logo File Item */
.bp-logo-file-item {
  display: flex;
  align-items: center;
  background: #ffffff;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 0.5rem 0.75rem;
  transition: all 0.2s ease;
  cursor: pointer;
  min-height: 60px;
}

.bp-logo-file-item:hover {
  background: #f8f9fa;
  border-color: #dee2e6;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}


/* Logo File Thumbnail */
.bp-logo-thumbnail {
  width: 48px;
  height: 48px;
  object-fit: contain;
  border-radius: 6px;
  background: #f8f9fa;
  margin-right: 0.75rem;
  flex-shrink: 0;
}

/* Logo File Metadata */
.bp-logo-metadata {
  flex: 1;
  min-width: 0;
}

.bp-logo-name {
  font-size: 0.875rem;
  font-weight: 500;
  color: #212529;
  margin: 0 0 0.25rem 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.bp-logo-details {
  font-size: 0.75rem;
  color: #6c757d;
  margin: 0;
  display: flex;
  gap: 1rem;
}

.bp-logo-detail-item {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

/* Remove Button - Simplified and Always Visible */
.bp-logo-remove-btn {
  background: none !important;
  border: none !important;
  outline: none !important;
  color: #dc3545 !important;
  font-size: 1.2rem !important;
  padding: 4px !important;
  margin: 0 !important;
  cursor: pointer !important;
  display: inline-block !important;
  visibility: visible !important;
  opacity: 1 !important;
  width: 24px !important;
  height: 24px !important;
  text-align: center !important;
  line-height: 1 !important;
  flex-shrink: 0 !important;
  position: relative !important;
}

.bp-logo-remove-btn:hover {
  color: #a71e2a !important;
}

.bp-logo-remove-btn i {
  font-size: 1rem !important;
  color: inherit !important;
  display: block !important;
  width: 100% !important;
  text-align: center !important;
}

/* Force button visibility in file item */
.bp-logo-file-item .bp-logo-remove-btn {
  display: inline-block !important;
  visibility: visible !important;
  opacity: 1 !important;
  margin-left: auto !important;
  order: 999 !important;
}

/* New simplified remove button - system dark blue theme */
.bp-logo-remove-btn-simple {
  background: none !important;
  border: none !important;
  color: var(--bp-primary-600) !important; /* System dark blue */
  font-size: 1.4rem !important;
  font-weight: bold !important;
  padding: 2px 8px !important;
  cursor: pointer !important;
  margin-left: auto !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 28px !important;
  height: 28px !important;
  line-height: 1 !important;
  flex-shrink: 0 !important;
  border-radius: 4px !important;
  transition: all 0.2s ease !important;
}

.bp-logo-remove-btn-simple:hover {
  background-color: rgba(17, 79, 104, 0.1) !important; /* System dark blue with transparency */
  color: var(--bp-primary-700) !important; /* Darker system blue */
}

/* Completion Message */
.bp-upload-complete {
  text-align: center;
  padding: 2rem;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  border-radius: 12px;
  margin: 1.5rem;
}

.bp-upload-complete i {
  font-size: 3rem;
  color: #28a745;
  margin-bottom: 1rem;
}

.bp-upload-complete h6 {
  color: #28a745;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.bp-upload-complete p {
  color: #6c757d;
  margin: 0;
}

/* Responsive Design */
@media (max-width: 576px) {
  .bp-modern-drop-zone {
    padding: 2rem 1rem;
    margin: 1rem;
  }
  
  .bp-drop-title {
    font-size: 1rem;
  }
  
  .bp-drop-subtitle {
    font-size: 0.8rem;
  }
  
  .bp-modern-file-item {
    padding: 0.75rem;
  }
  
  .bp-modern-file-icon {
    width: 40px;
    height: 40px;
    margin-right: 0.75rem;
  }
  
  .bp-modern-file-name {
    font-size: 0.85rem;
  }
  
  .bp-modern-file-size {
    font-size: 0.75rem;
  }
}

/* Scrollbar Styling for File List */
.bp-file-list-items::-webkit-scrollbar {
  width: 6px;
}

.bp-file-list-items::-webkit-scrollbar-track {
  background: #f8f9fa;
  border-radius: 3px;
}

.bp-file-list-items::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 3px;
}

.bp-file-list-items::-webkit-scrollbar-thumb:hover {
  background: #a0aec0;
}
</style>
{% endblock %}